<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Utils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">com.irurueta:irurueta-navigation</a> &gt; <a href="index.source.html" class="el_package">com.irurueta.navigation.indoor</a> &gt; <span class="el_source">Utils.java</span></div><h1>Utils.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2018 Alberto Irurueta Carro (alberto@irurueta.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.irurueta.navigation.indoor;

import com.irurueta.algebra.AlgebraException;
import com.irurueta.algebra.Matrix;
import com.irurueta.geometry.Point2D;
import com.irurueta.geometry.Point3D;
import com.irurueta.navigation.indoor.radiosource.RssiRadioSourceEstimator;
import com.irurueta.numerical.EvaluationException;
import com.irurueta.numerical.JacobianEstimator;
import com.irurueta.numerical.MultiVariateFunctionEvaluatorListener;
import com.irurueta.statistics.MultivariateNormalDist;
import com.irurueta.statistics.StatisticsException;

@SuppressWarnings(&quot;Duplicates&quot;)
public class Utils {

    /**
     * Speed of light expressed in meters per second (m/s).
     */
    public static final double SPEED_OF_LIGHT = RssiRadioSourceEstimator.SPEED_OF_LIGHT;

    /**
     * Prevents instantiation
     */
    private Utils() { }

    /**
     * Converts from dBm's to linear power value expressed in mW.
     * @param dBm value to be converted expressed in dBm's.
     * @return converted value expressed in mW.
     */
    public static double dBmToPower(double dBm) {
<span class="fc" id="L48">        return Math.pow(10.0, dBm / 10.0);</span>
    }

    /**
     * Converts from mW to logarithmic power value expressed in dBm's.
     * @param mW value to be converted expressed in mW's.
     * @return converted value expressed in dBm's.
     */
    public static double powerTodBm(double mW) {
<span class="fc" id="L57">        return 10.0 * Math.log10(mW);</span>
    }

    /**
     * Propagates variance on received power measure into distance variance by considering the following formula
     * for received power (expressed in dBm's):
     * rxPower = pathLossExponent * kdB + txPower - 5.0 * pathLossExponent * logSqrDistance,
     * where logSqrDistance is the logarithm in base 10 of the squared distance logSqrDistance = Math.log(d^2).
     * Taking into account the previous formula, distance can be expressed as:
     * d = 10.0^((pathLossExponent * kdB + txPower - rxPower)/(10.0 * pathLossExponent))
     * where kdB is a constant having the following expression:
     * kdB = 10.0 * log(c / (4 * pi * f)),
     * where c is the speed of light and f is the frequency.
     * @param txPower transmitted power expressed in dBm's.
     * @param rxPower received power expressed in dBm's.
     * @param pathLossExponent path loss exponent.
     * @param frequency frequency expressed in Hz.
     * @param rxPowerVariance received power variance.
     * @return distance variance.
     */
    public static double propagatePowerVarianceToDistanceVariance(double txPower,
            double rxPower, double pathLossExponent, double frequency,
            Double rxPowerVariance) {
<span class="fc bfc" id="L80" title="All 2 branches covered.">        if (rxPowerVariance == null) {</span>
<span class="fc" id="L81">            return 0.0;</span>
        }

<span class="fc" id="L84">        double k = SPEED_OF_LIGHT / (4.0 * Math.PI * frequency);</span>
<span class="fc" id="L85">        double kdB = 10.0 * Math.log10(k);</span>

        //distance follows the following expression:
        //d = 10.0^((pathLossExponent * kdB + txPower - rxPower)/(10.0 * pathLossExponent))
        //where kdB is a constant having the following expression:
        //kdB = 10.0 * log(c / (4 * pi * f)),
        //where c is the speed of light and f is the frequency.

        //hence, if the only unknown is the received power (x = rxPower), we can express the distance as:
        //d = f(x) = 10.0^((pathLossExponent * kdB + txPower - x)/(10.0 * pathLossExponent))

        //if we know the variance of received power var(x), then the variance of the distance will be:
        //var(d) = var(f(x)) = (f'(E(x)))^2*var(x)
        //where f'(x) is the derivative of f(x) evaluated at E(x) = rxPower

        //the derivative f'(x) has the following expression:
        //f'(x) = -ln(10)/(10.0*pathLossExponent)*10^((pathLossExponent * kdB + txPower - x)/(10.0 * pathLossExponent))

        //evaluate derivative at E(x) = rxPower:
<span class="fc" id="L104">        double tenPathLossExponent = 10.0 * pathLossExponent;</span>
<span class="fc" id="L105">        double derivativeF = -Math.log(10.0) / tenPathLossExponent * Math.pow(10.0,</span>
                (pathLossExponent * kdB + txPower - rxPower) / tenPathLossExponent);

<span class="fc" id="L108">        return derivativeF * derivativeF * rxPowerVariance;</span>
    }

    /**
     * Propagates provided variances (transmitted power variance, received power variance and pathloss variance) into
     * distance variance by considering the following formula for received power (expressed in dBm's):
     * rxPower = pathLossExponent * kdB + txPower - 5.0 * pathLossExponent * logSqrDistance,
     * where logSqrDistance is the logarithm in base 10 of the squared distance logSqrDistance = Math.log(d^2).
     * Taking into account the previous formula, distance can be expressed as:
     * d = 10.0^((pathLossExponent * kdB + txPower - rxPower)/(10.0 * pathLossExponent))
     * where kdB is a constant having the following expression:
     * kdB = 10.0 * log(c / (4 * pi * f)),
     * where c is the speed of light and f is the frequency.
     * @param txPower transmitted power expressed in dBm's.
     * @param rxPower received power expressed in dBm's.
     * @param pathLossExponent path loss exponent.
     * @param frequency frequency expressed in Hz.
     * @param txPowerVariance transmitted power variance.
     * @param rxPowerVariance received power variance.
     * @param pathLossExponentVariance path loss exponent variance.
     * @return a normal distribution containing both expected distance and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToDistanceVariance(final double txPower,
            final double rxPower, final double pathLossExponent, final double frequency,
            Double txPowerVariance, Double rxPowerVariance,
            Double pathLossExponentVariance) throws IndoorException {
<span class="pc bpc" id="L135" title="2 of 6 branches missed.">        if (txPowerVariance == null &amp;&amp; rxPowerVariance == null &amp;&amp; pathLossExponentVariance == null) {</span>
<span class="fc" id="L136">            return null;</span>
        }

<span class="fc" id="L139">        double[] mean = new double[]{ txPower, rxPower, pathLossExponent };</span>
<span class="fc" id="L140">        Matrix covariance = Matrix.diagonal(new double[]{</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">                txPowerVariance != null ? txPowerVariance : 0.0,</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">                rxPowerVariance != null ? rxPowerVariance : 0.0,</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0</span>
        });

        try {
<span class="fc" id="L147">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(double[] x, double[] y, Matrix jacobian) {
<span class="fc" id="L150">                    double k = RssiRadioSourceEstimator.SPEED_OF_LIGHT / (4.0 * Math.PI * frequency);</span>
<span class="fc" id="L151">                    double kdB = 10.0 * Math.log10(k);</span>

                    //received power in dBm's follows the equation:
                    //rxPower = pathLossExponent * kdB + txPower - 5.0 * pathLossExponent * logSqrDistance

                    //hence, distance follows the following expression:
                    //d = 10.0^((pathLossExponent * kdB + txPower - rxPower)/(10.0 * pathLossExponent))
                    //where kdB is a constant having the following expression:
                    //kdB = 10.0 * log(c / (4 * pi * f)),
                    //where c is the speed of light and f is the frequency.

<span class="fc" id="L162">                    double logSqrDistance = (pathLossExponent * kdB + txPower - rxPower) / (5.0 * pathLossExponent);</span>

                    //where logSqrDistance = Math.log10(sqrDistance)
                    //and sqrDistance = distance * distance, hence
                    //logSqrDistance = Math.log10(distance * distance) = 2 * Math.log10(distance)

<span class="fc" id="L168">                    y[0] = Math.pow(10.0,logSqrDistance / 2.0);</span>



                    //compute gradient (is a jacobian having 1 row and 3 columns)

                    //derivative of distance respect to transmitted power is:

                    //if the only unknown is the transmitted power (x = txPower), then:
                    //d = f(x) = 10.0^((pathLossExponent * kdB + x - rxPower)/(10.0 * pathLossExponent))
                    //and the derivative is
                    //f'(x) = ln(10)/(10.0 * pathLossExponent)*10.0^((pathLossExponent * kdB + x - rxPower)/(10.0 * pathLossExponent))
<span class="fc" id="L180">                    double tenPathLossExponent = 10.0 * pathLossExponent;</span>
<span class="fc" id="L181">                    double tenPowered = Math.pow(10.0,</span>
                            (pathLossExponent * kdB + txPower - rxPower) / tenPathLossExponent);
<span class="fc" id="L183">                    double derivativeTxPower = Math.log(10.0) / tenPathLossExponent * tenPowered;</span>

                    //derivative of distance respect to received power is:

                    //if the only unknown is the received power (x = rxPower), then:
                    //d = f(x) = 10.0^((pathLossExponent * kdB + txPower - x)/(10.0 * pathLossExponent))
                    //and the derivative is
                    //f'(x) = -ln(10)/(10.0*pathLossExponent)*10^((pathLossExponent * kdB + txPower - x)/(10.0 * pathLossExponent))
<span class="fc" id="L191">                    double derivativeRxPower = -Math.log(10.0) / tenPathLossExponent * tenPowered;</span>


                    //derivative respect to path loss exponent is:

                    //if the only unknown is the path loss exponent (x = pathLossExponent), then:
                    //d = f(x) = 10.0^((x * kdB + txPower - rxPower)/(10.0 * x))
                    //and the derivative is:
                    //f'(x) = ln(10) * g'(x) * 10.0^(g(x))
                    //where g(x) is:
                    //g(x) = (x * kdB + txPower - rxPower) / (10.0 * x)
                    //and the derivative of g(x) is:
                    //g'(x) = (kdB * 10.0 * x - 10.0 * (x * kdB + txPower - rxPower)) / (10.0 * x)^2
                    //Hence:
                    //f'(x) = lng(10) * (kdB * 10.0 * x - 10.0 * (x * kdB + txPower - rxPower)) / (10.0 * x)^2 * 10.0^((x * kdB + txPower - rxPower)/(10.0 * x))

<span class="fc" id="L207">                    double g = (pathLossExponent * kdB + txPower - rxPower) / (10.0 * pathLossExponent);</span>
<span class="fc" id="L208">                    double derivativeG = (kdB * 10.0 * pathLossExponent -</span>
                            10.0 * (pathLossExponent * kdB + txPower - rxPower)) /
<span class="fc" id="L210">                            Math.pow(10.0 * pathLossExponent, 2.0);</span>

<span class="fc" id="L212">                    double derivativePathLossExponent = Math.log(10.0) * derivativeG * Math.pow(10.0, g);</span>

<span class="fc" id="L214">                    jacobian.setElementAtIndex(0, derivativeTxPower);</span>
<span class="fc" id="L215">                    jacobian.setElementAtIndex(1, derivativeRxPower);</span>
<span class="fc" id="L216">                    jacobian.setElementAtIndex(2, derivativePathLossExponent);</span>
<span class="fc" id="L217">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L221">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L224">        } catch (AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L225">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (fingerprint rssi variance, path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * rssi variance by considering the 2D 1st order Taylor expression of received power.
     * Notice that any unknown variance is assumed to be zero.
     * @param fingerprintRssi closest located fingerprint reading RSSI expressed in dBm's.
     * @param pathLossExponent path-loss exponent.
     * @param fingerprintPosition position of closest fingerprint.
     * @param radioSourcePosition radio source position associated to fingerprint reading.
     * @param estimatedPosition  position to be estimated. Usually this is equal to the
     *                           initial position used by a non linear algorithm.
     * @param fingerprintRssiVariance variance of fingerprint RSSI or null if unknown.
     * @param pathLossExponentVariance variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance  covariance of position to be estimated or null
     *                                     if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiVarianceFirstOrderNonLinear2D(
            final double fingerprintRssi, final double pathLossExponent,
            Point2D fingerprintPosition, Point2D radioSourcePosition,
            Point2D estimatedPosition,
            Double fingerprintRssiVariance,
            Double pathLossExponentVariance,
            Matrix fingerprintPositionCovariance,
            Matrix radioSourcePositionCovariance,
            Matrix estimatedPositionCovariance) throws IndoorException {

<span class="fc bfc" id="L261" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null ||</span>
                estimatedPosition == null) {
<span class="fc" id="L263">            return null;</span>
        }

        //1st order Taylor expression of received power in 2D:
        //Pr(pi) = Pr(p1)
        //  - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
        //  - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
        //where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2

<span class="fc" id="L272">        final double x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L273">        final double y1 = fingerprintPosition.getInhomY();</span>

<span class="fc" id="L275">        final double xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L276">        final double ya = radioSourcePosition.getInhomY();</span>

<span class="fc" id="L278">        final double xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L279">        final double yi = estimatedPosition.getInhomY();</span>

<span class="fc" id="L281">        double[] mean = new double[] {</span>
                fingerprintRssi, pathLossExponent, x1, y1, xa, ya, xi, yi
        };
<span class="fc" id="L284">        Matrix covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L285" title="All 2 branches covered.">                fingerprintRssiVariance != null ? fingerprintRssiVariance : 0.0,</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L290" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L294">            covariance.setSubmatrix(2, 2,</span>
                    3, 3,
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L299" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L302">            covariance.setSubmatrix(4, 4,</span>
                    5, 5,
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L307" title="All 2 branches covered.">        if (estimatedPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L308" title="1 of 2 branches missed.">                estimatedPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">                estimatedPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L310">            covariance.setSubmatrix(6, 6,</span>
                    7, 7,
                    estimatedPositionCovariance);
        }

        try {
<span class="fc" id="L316">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(double[] x, double[] y, Matrix jacobian) {

                    //Pr(pi) = Pr(p1)
                    //  - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //  - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
                    //where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2

                    //Hence:
                    //Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/
                    //      (ln(10)*((x1 - xa)^2 + (y1 - ya)^2))

<span class="fc" id="L329">                    double diffX1a = x1 - xa;</span>
<span class="fc" id="L330">                    double diffY1a = y1 - ya;</span>

<span class="fc" id="L332">                    double diffXi1 = xi - x1;</span>
<span class="fc" id="L333">                    double diffYi1 = yi - y1;</span>

<span class="fc" id="L335">                    double diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L336">                    double diffY1a2 = diffY1a * diffY1a;</span>

<span class="fc" id="L338">                    double d1a2 = diffX1a2 + diffY1a2;</span>
<span class="fc" id="L339">                    double d1a4 = d1a2 * d1a2;</span>

<span class="fc" id="L341">                    double ln10 = Math.log(10.0);</span>
<span class="fc" id="L342">                    double crossDiff = diffX1a * diffXi1 + diffY1a * diffYi1;</span>

<span class="fc" id="L344">                    y[0] = fingerprintRssi</span>
                            - 10.0 * pathLossExponent * crossDiff / (ln10 * d1a2);

                    //compute gradient (is a jacobian having 1 row and 8 columns)


                    //derivative of rssi respect to fingerprint rssi
<span class="fc" id="L351">                    double derivativeFingerprintRssi = 1.0;</span>

                    //derivative of rssi respect to path-loss exponent

                    //diff(Pr(pi))/diff(n) = -10*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //  -10*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
<span class="fc" id="L357">                    double derivativePathLossExponent = - 10.0 * crossDiff /</span>
                            (ln10 * d1a2);


                    //derivative of rssi respect to x1

                    //We have
                    //Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/
                    //      (ln(10)*((x1 - xa)^2 + (y1 - ya)^2))

                    //and we know that: (f(x)/g(x))' = (f'(x)*g(x) - f(x)*g'(x))/g(x)^2
                    //and also that (f(x)*g(x))' = f'(x)*g(x) + f(x)*g'(x)

                    //Hence
                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(x1) =
                    //  diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(x1) =
                    //  diff(-x1^2 + (xi + xa)*x1 - xa*xi)/diff(x1) =
                    //  -2*x1 + xi + xa

                    //diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(x1 - xa))/d1a^4
<span class="fc" id="L378">                    double tmpX = 2.0 * crossDiff * diffX1a;</span>
<span class="fc" id="L379">                    double derivativeX1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * x1 + xi + xa) * d1a2</span>
                            - tmpX) / d1a4;

                    //derivative of rssi respect to y1

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(y1) =
                    //  diff(y1*yi -ya*yi -y1^2 + ya*y1)/diff(y1) =
                    //  diff(-y1^2 + (yi + ya)*y1 - ya*yi)/diff(y1) =
                    //  -2*y1 + yi + ya

                    //diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(y1 - ya))/d1a^4
<span class="fc" id="L391">                    double tmpY = 2.0 * crossDiff * diffY1a;</span>
<span class="fc" id="L392">                    double derivativeY1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * y1 + yi + ya) * d1a2</span>
                            - tmpY) / d1a4;


                    //derivative of rssi respect to xa

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(xa) =
                    //  diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(xa) =
                    //  x1 - xi

                    //diff(Pr(pi))/diff(xa) = -10*n/ln(10)*((x1 - xi)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //diff(Pr(pi))/diff(xa) = -10*n/ln(10)*(-(xi - x1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(x1 - xa))/d1a^4
<span class="fc" id="L404">                    double derivativeXa = -10.0 * pathLossExponent / ln10 * (-diffXi1 * d1a2</span>
                            + tmpX) / d1a4;


                    //derivative of rssi respect to ya

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(ya) =
                    //  diff(y1*yi -y1^2 -ya*yi + ya*y1)/diff(ya) =
                    //  y1 - yi

                    //diff(Pr(pi))/diff(ya) = -10*n/ln(10)*((y1 - yi)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //diff(Pr(pi))/diff(ya) = -10*n/ln(10)*(-(yi - y1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(y1 - ya))/d1a^4
<span class="fc" id="L416">                    double derivativeYa = -10.0 * pathLossExponent / ln10 *(-diffYi1 * d1a2</span>
                            + tmpY) / d1a4;


                    //derivative of rssi respect to xi

                    //Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/
                    //      (ln(10)*((x1 - xa)^2 + (y1 - ya)^2))

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(xi) =
                    //  diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(xi) =
                    //  x1 - xa

                    //diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*0)/(x1 - xa)^2 + (y1 - ya)^2)^2
                    //diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*d1a^2)/d1a^4
                    //diff(Pr(pi))/diff(xi) = -10*n*(x1 - xa)/(ln(10)*d1a^2)
<span class="fc" id="L432">                    double derivativeXi = -10.0 * pathLossExponent * diffX1a / (ln10 * d1a2);</span>


                    //derivative of rssi respect to yi

                    //Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/
                    //      (ln(10)*((x1 - xa)^2 + (y1 - ya)^2))

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(yi) =
                    //  diff(y1*yi -ya*yi -y1^2 + ya*y1)/diff(yi) =
                    //  y1 - ya

                    //diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*0)/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*d1a^2)/d1a^4
                    //diff(Pr(pi))/diff(yi) = -10*n*(y1 - ya)/(ln(10)*d1a^2)
<span class="fc" id="L447">                    double derivativeYi = -10.0 * pathLossExponent * diffY1a / (ln10 * d1a2);</span>

                    //set derivatives fingerprintRssi, pathLossExponent, x1, y1, xa, ya, xi, yi
<span class="fc" id="L450">                    jacobian.setElementAtIndex(0, derivativeFingerprintRssi);</span>
<span class="fc" id="L451">                    jacobian.setElementAtIndex(1, derivativePathLossExponent);</span>
<span class="fc" id="L452">                    jacobian.setElementAtIndex(2, derivativeX1);</span>
<span class="fc" id="L453">                    jacobian.setElementAtIndex(3, derivativeY1);</span>
<span class="fc" id="L454">                    jacobian.setElementAtIndex(4, derivativeXa);</span>
<span class="fc" id="L455">                    jacobian.setElementAtIndex(5, derivativeYa);</span>
<span class="fc" id="L456">                    jacobian.setElementAtIndex(6, derivativeXi);</span>
<span class="fc" id="L457">                    jacobian.setElementAtIndex(7, derivativeYi);</span>
<span class="fc" id="L458">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L462">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L465">        } catch (AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L466">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (fingerprint rssi variance, path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * rssi variance by considering the 3D 1st order Taylor expression of received power.
     * Notice that any unknown variance is assumed to be zero.
     * @param fingerprintRssi closest located fingerprint reading RSSI expressed in dBm's.
     * @param pathLossExponent path-loss exponent.
     * @param fingerprintPosition position of closest fingerprint.
     * @param radioSourcePosition radio source position associated to fingerprint reading.
     * @param estimatedPosition  position to be estimated. Usually this is equal to the
     *                           initial position used by a non linear algorithm.
     * @param fingerprintRssiVariance variance of fingerprint RSSI or null if unknown.
     * @param pathLossExponentVariance variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance  covariance of position to be estimated or null
     *                                     if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiVarianceFirstOrderNonLinear3D(
            final double fingerprintRssi, final double pathLossExponent,
            Point3D fingerprintPosition, Point3D radioSourcePosition,
            Point3D estimatedPosition,
            Double fingerprintRssiVariance,
            Double pathLossExponentVariance,
            Matrix fingerprintPositionCovariance,
            Matrix radioSourcePositionCovariance,
            Matrix estimatedPositionCovariance) throws IndoorException {

<span class="fc bfc" id="L502" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null ||</span>
                estimatedPosition == null) {
<span class="fc" id="L504">            return null;</span>
        }

        //1st order Taylor expression of received power in 3D:
        //Pr(pi) = Pr(p1)
        //  - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
        //  - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
        //  - 10*n*(z1 - za)/(ln(10)*d1a^2)*(zi - z1)
        //where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2

<span class="fc" id="L514">        final double x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L515">        final double y1 = fingerprintPosition.getInhomY();</span>
<span class="fc" id="L516">        final double z1 = fingerprintPosition.getInhomZ();</span>

<span class="fc" id="L518">        final double xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L519">        final double ya = radioSourcePosition.getInhomY();</span>
<span class="fc" id="L520">        final double za = radioSourcePosition.getInhomZ();</span>

<span class="fc" id="L522">        final double xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L523">        final double yi = estimatedPosition.getInhomY();</span>
<span class="fc" id="L524">        final double zi = estimatedPosition.getInhomZ();</span>

<span class="fc" id="L526">        double[] mean = new double[] {</span>
                fingerprintRssi, pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
        };
<span class="fc" id="L529">        Matrix covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L530" title="All 2 branches covered.">                fingerprintRssiVariance != null ? fingerprintRssiVariance : 0.0,</span>
<span class="fc bfc" id="L531" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L535" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L536" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L537" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L539">            covariance.setSubmatrix(2, 2,</span>
                    4, 4,
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L544" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L546" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L547">            covariance.setSubmatrix(5, 5,</span>
                    7, 7,
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L552" title="All 2 branches covered.">        if (estimatedPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L553" title="1 of 2 branches missed.">                estimatedPositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L554" title="1 of 2 branches missed.">                estimatedPositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L555">            covariance.setSubmatrix(8, 8,</span>
                    10, 10,
                    estimatedPositionCovariance);
        }

        try {
<span class="fc" id="L561">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(double[] x, double[] y, Matrix jacobian) {

                    //Pr(pi) = Pr(p1)
                    //  - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //  - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
                    //  - 10*n*(z1 - za)/(ln(10)*d1a^2)*(zi - z1)
                    //where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2

                    //Hence:
                    //Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/
                    //      (ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

<span class="fc" id="L575">                    double diffX1a = x1 - xa;</span>
<span class="fc" id="L576">                    double diffY1a = y1 - ya;</span>
<span class="fc" id="L577">                    double diffZ1a = z1 - za;</span>

<span class="fc" id="L579">                    double diffXi1 = xi - x1;</span>
<span class="fc" id="L580">                    double diffYi1 = yi - y1;</span>
<span class="fc" id="L581">                    double diffZi1 = zi - z1;</span>

<span class="fc" id="L583">                    double diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L584">                    double diffY1a2 = diffY1a * diffY1a;</span>
<span class="fc" id="L585">                    double diffZ1a2 = diffZ1a * diffZ1a;</span>

<span class="fc" id="L587">                    double d1a2 = diffX1a2 + diffY1a2 + diffZ1a2;</span>
<span class="fc" id="L588">                    double d1a4 = d1a2 * d1a2;</span>

<span class="fc" id="L590">                    double ln10 = Math.log(10.0);</span>
<span class="fc" id="L591">                    double crossDiff = diffX1a * diffXi1 + diffY1a * diffYi1 + diffZ1a * diffZi1;</span>

<span class="fc" id="L593">                    y[0] = fingerprintRssi</span>
                            - 10.0 * pathLossExponent * crossDiff / (ln10 * d1a2);

                    //compute gradient (is a jacobian having 1 row and 11 columns)


                    //derivative of rssi respect to fingerprint rssi
<span class="fc" id="L600">                    double derivativeFingerprintRssi = 1.0;</span>

                    //derivative of rssi respect to path-loss exponent

                    //diff(Pr(pi))/diff(n) = -10*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //  -10*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
<span class="fc" id="L606">                    double derivativePathLossExponent = - 10.0 * crossDiff /</span>
                            (ln10 * d1a2);


                    //derivative of rssi respect to x1

                    //We have
                    //Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/
                    //      (ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

                    //and we know that: (f(x)/g(x))' = (f'(x)*g(x) - f(x)*g'(x))/g(x)^2
                    //and also that (f(x)*g(x))' = f'(x)*g(x) + f(x)*g'(x)

                    //Hence
                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(x1) =
                    //  diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(x1) =
                    //  diff(-x1^2 + (xi + xa)*x1 - xa*xi)/diff(x1) =
                    //  -2*x1 + xi + xa

                    //diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(x1 - xa))/d1a^4
<span class="fc" id="L627">                    double tmpX = 2.0 * crossDiff * diffX1a;</span>
<span class="fc" id="L628">                    double derivativeX1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * x1 + xi + xa) * d1a2</span>
                            - tmpX) / d1a4;


                    //derivative of rssi respect to y1

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(y1) =
                    //  diff(y1*yi -ya*yi -y1^2 + ya*y1)/diff(y1) =
                    //  diff(-y1^2 + (yi + ya)*y1 - ya*yi)/diff(y1) =
                    //  -2*y1 + yi + ya

                    //diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(y1 - ya))/d1a^4
<span class="fc" id="L641">                    double tmpY = 2.0 * crossDiff * diffY1a;</span>
<span class="fc" id="L642">                    double derivativeY1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * y1 + yi + ya) * d1a2</span>
                            - tmpY) / d1a4;


                    //derivative of rssi respect to z1

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(z1) =
                    //  diff(z1*zi -za*zi -z1^2 + za*z1)/diff(z1) =
                    //  diff(-z1^2 + (zi + za)*z1 - za*zi)/diff(z1) =
                    //  -2*z1 + zi + za

                    //diff(Pr(pi))/diff(z1) = -10*n/ln(10)*((-2*z1 + zi + za)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //diff(Pr(pi))/diff(z1) = -10*n/ln(10)*((-2*z1 + zi + za)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(z1 - za))/d1a^4
<span class="fc" id="L655">                    double tmpZ = 2.0 * crossDiff * diffZ1a;</span>
<span class="fc" id="L656">                    double derivativeZ1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * z1 + z1 + za) * d1a2</span>
                            - tmpZ) / d1a4;


                    //derivative of rssi respect to xa

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(xa) =
                    //  diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(xa) =
                    //  x1 - xi

                    //diff(Pr(pi))/diff(xa) = -10*n/ln(10)*((x1 - xi)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //diff(Pr(pi))/diff(xa) = -10*n/ln(10)*(-(xi - x1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(x1 - xa))/d1a^4
<span class="fc" id="L668">                    double derivativeXa = -10.0 * pathLossExponent / ln10 * (-diffXi1 * d1a2</span>
                            + tmpX) / d1a4;


                    //derivative of rssi respect to ya

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(ya) =
                    //  diff(y1*yi -y1^2 -ya*yi + ya*y1)/diff(ya) =
                    //  y1 - yi

                    //diff(Pr(pi))/diff(ya) = -10*n/ln(10)*((y1 - yi)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //diff(Pr(pi))/diff(ya) = -10*n/ln(10)*(-(yi - y1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(y1 - ya))/d1a^4
<span class="fc" id="L680">                    double derivativeYa = -10.0 * pathLossExponent / ln10 *(-diffYi1 * d1a2</span>
                            + tmpY) / d1a4;


                    //derivative of rssi respect to za

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(za) =
                    //  diff(z1*zi -z1^2 -za*zi + za*z1)/diff(za) =
                    //  z1 - zi

                    //diff(Pr(pi))/diff(za) = -10*n/ln(10)*((z1 - zi)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //diff(Pr(pi))/diff(za) = -10*n/ln(10)*(-(zi - z1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(z1 - za))/d1a^4
<span class="fc" id="L692">                    double derivativeZa = -10.0 * pathLossExponent / ln10 *(- diffZi1 * d1a2 +</span>
                            + tmpZ) / d1a4;


                    //derivative of rssi respect to xi

                    //Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/
                    //      (ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(xi) =
                    //  diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(xi) =
                    //  x1 - xa

                    //diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*d1a^2)/d1a^4
                    //diff(Pr(pi))/diff(xi) = -10*n*(x1 - xa)/(ln(10)*d1a^2)
<span class="fc" id="L708">                    double derivativeXi = -10.0 * pathLossExponent * diffX1a / (ln10 * d1a2);</span>


                    //derivative of rssi respect to yi

                    //Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/
                    //      (ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(yi) =
                    //  diff(y1*yi -ya*yi -y1^2 + ya*y1)/diff(yi) =
                    //  y1 - ya

                    //diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*d1a^2)/d1a^4
                    //diff(Pr(pi))/diff(yi) = -10*n*(y1 - ya)/(ln(10)*d1a^2)
<span class="fc" id="L723">                    double derivativeYi = -10.0 * pathLossExponent * diffY1a / (ln10 * d1a2);</span>


                    //derivative of rssi respect to zi

                    //Pr(pi) = Pr(p1) -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/
                    //      (ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(zi) =
                    //  diff(z1*zi -za*zi -z1^2 + za*z1)/diff(zi) =
                    //  z1 - za

                    //diff(Pr(pi))/diff(zi) = -10*n/ln(10)*((z1 - za)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //diff(Pr(pi))/diff(zi) = -10*n/ln(10)*((z1 - za)*d1a^2)/d1a^4
                    //diff(Pr(pi))/diff(zi) = -10*n*(z1 - za)/(ln(10*d1a^2)
<span class="fc" id="L738">                    double derivativeZi = -10.0 * pathLossExponent * diffZ1a / (ln10 * d1a2);</span>

                    //set derivatives fingerprintRssi, pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
<span class="fc" id="L741">                    jacobian.setElementAtIndex(0, derivativeFingerprintRssi);</span>
<span class="fc" id="L742">                    jacobian.setElementAtIndex(1, derivativePathLossExponent);</span>
<span class="fc" id="L743">                    jacobian.setElementAtIndex(2, derivativeX1);</span>
<span class="fc" id="L744">                    jacobian.setElementAtIndex(3, derivativeY1);</span>
<span class="fc" id="L745">                    jacobian.setElementAtIndex(4, derivativeZ1);</span>
<span class="fc" id="L746">                    jacobian.setElementAtIndex(5, derivativeXa);</span>
<span class="fc" id="L747">                    jacobian.setElementAtIndex(6, derivativeYa);</span>
<span class="fc" id="L748">                    jacobian.setElementAtIndex(7, derivativeZa);</span>
<span class="fc" id="L749">                    jacobian.setElementAtIndex(8, derivativeXi);</span>
<span class="fc" id="L750">                    jacobian.setElementAtIndex(9, derivativeYi);</span>
<span class="fc" id="L751">                    jacobian.setElementAtIndex(10, derivativeZi);</span>
<span class="fc" id="L752">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L756">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L759">        } catch (AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L760">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (fingerprint rssi variance, path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * rssi variance by considering the 2D 2nd order Taylor expression of received power.
     * Notice that any unknown variance is assumed to be zero.
     * @param fingerprintRssi closest located fingerprint reading RSSI expressed in dBm's.
     * @param pathLossExponent path-loss exponent.
     * @param fingerprintPosition position of closest fingerprint.
     * @param radioSourcePosition radio source position associated to fingerprint reading.
     * @param estimatedPosition  position to be estimated. Usually this is equal to the
     *                           initial position used by a non linear algorithm.
     * @param fingerprintRssiVariance variance of fingerprint RSSI or null if unknown.
     * @param pathLossExponentVariance variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance  covariance of position to be estimated or null
     *                                     if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiVarianceSecondOrderNonLinear2D(
            final double fingerprintRssi, final double pathLossExponent,
            Point2D fingerprintPosition, Point2D radioSourcePosition,
            Point2D estimatedPosition, Double fingerprintRssiVariance,
            Double pathLossExponentVariance,
            Matrix fingerprintPositionCovariance,
            Matrix radioSourcePositionCovariance,
            Matrix estimatedPositionCovariance) throws IndoorException {

<span class="fc bfc" id="L795" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null ||</span>
                estimatedPosition == null) {
<span class="fc" id="L797">            return null;</span>
        }

        //2nd order Taylor expression of received power in 2D:
        //Pr(pi) = Pr(p1)
        //  - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
        //  - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
        //  - 5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2
        //  - 5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*d1a^4)*(yi - y1)^2
        //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4))*(xi - x1)*(yi - y1)
        //where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2

<span class="fc" id="L809">        final double x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L810">        final double y1 = fingerprintPosition.getInhomY();</span>

<span class="fc" id="L812">        final double xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L813">        final double ya = radioSourcePosition.getInhomY();</span>

<span class="fc" id="L815">        final double xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L816">        final double yi = estimatedPosition.getInhomY();</span>

<span class="fc" id="L818">        double[] mean = new double[] {</span>
                fingerprintRssi, pathLossExponent, x1, y1, xa, ya, xi, yi
        };
<span class="fc" id="L821">        Matrix covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L822" title="All 2 branches covered.">                fingerprintRssiVariance != null ? fingerprintRssiVariance : 0.0,</span>
<span class="fc bfc" id="L823" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L827" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L828" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L829" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L831">            covariance.setSubmatrix(2, 2,</span>
                    3, 3,
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L836" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L837" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L838" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L839">            covariance.setSubmatrix(4, 4,</span>
                    5, 5,
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L844" title="All 2 branches covered.">        if (estimatedPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L845" title="1 of 2 branches missed.">                estimatedPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L846" title="1 of 2 branches missed.">                estimatedPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L847">            covariance.setSubmatrix(6, 6,</span>
                    7, 7,
                    estimatedPositionCovariance);
        }

        try {
<span class="fc" id="L853">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(double[] x, double[] y, Matrix jacobian) {

                    //Pr(pi) = Pr(p1)
                    //  - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //  - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
                    //  - 5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2
                    //  - 5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*d1a^4)*(yi - y1)^2
                    //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4))*(xi - x1)*(yi - y1)
                    //where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2

                    //Hence:
                    //Pr(pi) = Pr(p1)
                    //  - 10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*(xi - x1)
                    //  - 10*n*(y1 - ya)/(ln(10)*(x1 - xa)^2 + (y1 - ya)^2)*(yi - y1)
                    //  - 5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)^2
                    //  - 5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(yi - y1)^2
                    //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

<span class="fc" id="L873">                    double diffX1a = x1 - xa;</span>
<span class="fc" id="L874">                    double diffY1a = y1 - ya;</span>

<span class="fc" id="L876">                    double diffXi1 = xi - x1;</span>
<span class="fc" id="L877">                    double diffYi1 = yi - y1;</span>

<span class="fc" id="L879">                    double diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L880">                    double diffY1a2 = diffY1a * diffY1a;</span>

<span class="fc" id="L882">                    double diffXi12 = diffXi1 * diffXi1;</span>
<span class="fc" id="L883">                    double diffYi12 = diffYi1 * diffYi1;</span>

<span class="fc" id="L885">                    double d1a2 = diffX1a2 + diffY1a2;</span>
<span class="fc" id="L886">                    double d1a4 = d1a2 * d1a2;</span>
<span class="fc" id="L887">                    double d1a8 = d1a4 * d1a4;</span>

<span class="fc" id="L889">                    double ln10 = Math.log(10.0);</span>

<span class="fc" id="L891">                    y[0] = fingerprintRssi</span>
                            - 10.0 * pathLossExponent * diffX1a / (ln10 * d1a2) * diffXi1
                            - 10.0 * pathLossExponent * diffY1a / (ln10 * d1a2) * diffYi1
                            - 5.0 * pathLossExponent * (-diffX1a2 + diffY1a2) / (ln10 * d1a4) * diffXi12
                            - 5.0 * pathLossExponent * (diffX1a2 - diffY1a2) / (ln10 * d1a4) * diffYi12
                            + 20.0 * pathLossExponent * diffX1a * diffY1a / (ln10 * d1a4) * diffXi1 * diffYi1;

                    //compute gradient (is a jacobian having 1 row and 8 columns)


                    //derivative of rssi respect to fingerprint rssi
<span class="fc" id="L902">                    double derivativeFingerprintRssi = 1.0;</span>

                    //derivative of rssi respect to path-loss exponent

                    //diff(Pr(pi))/diff(n) = -10*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*(xi - x1)
                    //  -10*(y1 - ya)/(ln(10)*(x1 - xa)^2 + (y1 - ya)^2)*(yi - y1)
                    //  -5*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)^2
                    //  -5*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(yi - y1)^2
                    //  +20*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)
<span class="fc" id="L911">                    double derivativePathLossExponent = - 10.0 * diffX1a / (ln10 * d1a2) * diffXi1</span>
                            - 10.0 * diffY1a / (ln10 * d1a2) * diffYi1
                            - 5.0 * (-diffX1a2 + diffY1a2) / (ln10 * d1a4) * diffXi12
                            - 5.0 * (diffX1a2 - diffY1a2) / (ln10 * d1a4) * diffYi12
                            + 20.0 * diffX1a * diffY1a / (ln10 * d1a4) * diffXi1 * diffYi1;


                    //derivative of rssi respect to x1

                    //We have
                    //Pr(pi) = Pr(p1)
                    //  - 10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*(xi - x1)
                    //  - 10*n*(y1 - ya)/(ln(10)*(x1 - xa)^2 + (y1 - ya)^2)*(yi - y1)
                    //  - 5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)^2
                    //  - 5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(yi - y1)^2
                    //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    //Pr(pi) = Pr(p1)
                    //  - 10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))
                    //  + 5*n*((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)
                    //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)


                    //and we know that: (f(x)/g(x))' = (f'(x)*g(x) - f(x)*g'(x))/g(x)^2
                    //and also that (f(x)*g(x))' = f'(x)*g(x) + f(x)*g'(x)

                    //Hence
                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(x1) =
                    //  diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(x1) =
                    //  diff(-x1^2 + (xi + xa)*x1 - xa*xi)/diff(x1) =
                    //  -2*x1 + xi + xa

                    //diff(((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))/diff(x1) =
                    //  2*(x1 - xa)*((xi - x1)^2 - (yi - y1)^2) - 2*(xi - x1)*((x1 - xa)^2 - (y1 - ya)^2)

                    //diff((x1 - xa)*(y1 - ya))/diff(x1) =
                    //  y1 - ya

                    //diff((xi - x1)*(yi - y1))/diff(x1) =
                    // -(yi - y1)

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(x1) =
                    //  (y1 - ya)*(xi - x1)*(yi - y1) - (x1 - xa)*(y1 - ya)*(yi - y1) =
                    //  ((y1 - ya)*(xi - x1) - (x1 - xa)*(y1 - ya))*(yi - y1)

                    //diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //  + 5*n/ln(10)*(2*((x1 - xa)*((xi - x1)^2 - (yi - y1)^2) - (xi - x1)*((x1 - xa)^2 - (y1 - ya)^2))*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))*2*((x1 - xa)^2 + (y1 - ya)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^4
                    //  + 20*n/ln(10)*(((y1 - ya)*(xi - x1) - (x1 - xa)*(y1 - ya))*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^4

                    //diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(x1 - xa))/d1a^4
                    //  + 5*n/ln(10)*(2*((x1 - xa)*((xi - x1)^2 - (yi - y1)^2) - (xi - x1)*((x1 - xa)^2 - (y1 - ya)^2))*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))*4*d1a^2*(x1 - xa))/d1a^8
                    //  + 20*n/ln(10)*(((y1 - ya)*(xi - x1) - (x1 - xa)*(y1 - ya))*(yi - y1)*d1a^4 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(x1 - xa))/d1a^8
<span class="fc" id="L963">                    double crossDiff = diffX1a * diffXi1 + diffY1a * diffYi1;</span>
<span class="fc" id="L964">                    double tmpX = crossDiff * 2.0 * diffX1a;</span>
<span class="fc" id="L965">                    double tmpX2 = (diffX1a2 - diffY1a2) * (diffXi12 - diffYi12) * 4.0 * d1a2 * diffX1a;</span>
<span class="fc" id="L966">                    double tmpX3 = diffX1a * diffY1a * diffXi1 * diffYi1 * 4.0 * d1a2 * diffX1a;</span>
<span class="fc" id="L967">                    double derivativeX1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * x1 + xi + xa) * d1a2 - tmpX) / d1a4</span>
                            + 5.0 * pathLossExponent / ln10 * (2.0 * (diffX1a * (diffXi12 - diffYi12) - diffXi1 * (diffX1a2 - diffY1a2)) * d1a4 - tmpX2) / d1a8
                            + 20.0 * pathLossExponent / ln10 * ((diffY1a * diffXi1 - diffX1a * diffY1a) * diffYi1 * d1a4 - tmpX3) / d1a8;


                    //derivative of rssi respect to y1

                    //We have
                    //Pr(pi) = Pr(p1)
                    //  - 10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*(xi - x1)
                    //  - 10*n*(y1 - ya)/(ln(10)*(x1 - xa)^2 + (y1 - ya)^2)*(yi - y1)
                    //  - 5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)^2
                    //  - 5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(yi - y1)^2
                    //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    //Pr(pi) = Pr(p1)
                    //  - 10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))
                    //  + 5*n*((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)
                    //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)


                    //and we know that: (f(x)/g(x))' = (f'(x)*g(x) - f(x)*g'(x))/g(x)^2
                    //and also that (f(x)*g(x))' = f'(x)*g(x) + f(x)*g'(x)

                    //Hence
                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(y1) =
                    //  diff(y1*yi -ya*yi -y1^2 + ya*y1)/diff(y1) =
                    //  diff(-y1^2 + (yi + ya)*y1 - ya*yi)/diff(y1) =
                    //  -2*y1 + yi + ya

                    //diff(((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))/diff(y1) =
                    //  -2*(y1 - ya)*((xi - x1)^2 - (yi - y1)^2) + 2*(yi - y1)*((x1 - xa)^2 - (y1 - ya)^2)

                    //diff((x1 - xa)*(y1 - ya))/diff(y1) =
                    //  x1 - xa

                    //diff((xi - x1)*(yi - y1))/diff(y1) =
                    // -(xi - x1)

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(y1) =
                    //  (x1 - xa)*(xi - x1)*(yi - y1) - (x1 - xa)*(y1 - ya)*(xi - x1) =
                    //  ((x1 - xa)*(yi - y1) - (x1 - xa)*(y1 - ya))*(xi - x1)

                    //diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //  + 5*n/ln(10)*(2*(-(y1 - ya)*((xi - x1)^2 - (yi - y1)^2) + (yi - y1)*((x1 - xa)^2 - (y1 - ya)^2))*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^4
                    //  + 20*n/ln(10)*(((x1 - xa)*(yi - y1) - (x1 - xa)*(y1 - ya))*(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^4

                    //diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(y1 - ya))/d1a^4
                    //  + 5*n/ln(10)*(2*(-(y1 - ya)*((xi - x1)^2 - (yi - y1)^2) + (yi - y1)*((x1 - xa)^2 - (y1 - ya)^2))*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //  + 20*n/ln(10)*(((x1 - xa)*(yi - y1) - (x1 - xa)*(y1 - ya))*(xi - x1)*d1a^4 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(y1 - ya))/d1a^8
<span class="fc" id="L1017">                    double tmpY = crossDiff * 2.0 * diffY1a;</span>
<span class="fc" id="L1018">                    double tmpY2 = (diffX1a2 - diffY1a2) * (diffXi12 - diffYi12) * 4.0 * d1a2 * diffY1a;</span>
<span class="fc" id="L1019">                    double tmpY3 = diffX1a * diffY1a * diffXi1 * diffYi1 * 4.0 * d1a2 * diffY1a;</span>
<span class="fc" id="L1020">                    double derivativeY1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * y1 + yi + ya) * d1a2 - tmpY) / d1a4</span>
                            + 5.0 * pathLossExponent / ln10 * (2.0 * (-diffY1a * (diffXi12 - diffYi12) + diffYi1 * (diffX1a2 - diffY1a2)) * d1a4 - tmpY2) / d1a8
                            + 20.0 * pathLossExponent / ln10 * ((diffX1a * diffYi1 - diffX1a * diffY1a) * diffXi1 * d1a4 - tmpY3) / d1a8;


                    //derivative of rssi respect to xa

                    //Pr(pi) = Pr(p1)
                    //  - 10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))
                    //  + 5*n*((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)
                    //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(xa) =
                    //  -(xi - x1)

                    //diff(((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))/diff(xa) =
                    //  -2*(x1 - xa)*((xi - x1)^2 - (yi - y1)^2)

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(xa) =
                    //  -(y1 - ya)*(xi - x1)*(yi - y1)

                    //diff(Pr(pi))/diff(xa) = -10*n/ln(10)*(-(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //  + 5*n/ln(10)*(-2*(x1 - xa)*((xi - x1)^2 - (yi - y1)^2)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^4
                    //  + 20*n*(-(y1 - ya)*(xi - x1)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^4

                    //diff(Pr(pi))/diff(xa) = -10*n/ln(10)*(-(xi - x1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(x1 - xa))/d1a^4
                    //  + 5*n/ln(10)*(-2*(x1 - xa)*((xi - x1)^2 - (yi - y1)^2)*d1a^4 + ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //  + 20*n/ln(10)*(-(y1 - ya)*(xi - x1)*(yi - y1)*d1a^4 + (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(x1 - xa))/d1a^8
<span class="fc" id="L1048">                    double derivativeXa = -10.0 * pathLossExponent / ln10 * (-diffXi1 * d1a2 + tmpX) / d1a4</span>
                            + 5.0 * pathLossExponent / ln10 * (-2.0 * diffX1a * (diffXi12 - diffYi12) * d1a4 + tmpX2) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffY1a * diffXi1 * diffYi1 * d1a4 + tmpX3) / d1a8;


                    //derivative of rssi respect to ya

                    //Pr(pi) = Pr(p1)
                    //  - 10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))
                    //  + 5*n*((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)
                    //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(ya) =
                    //  -(yi - y1)

                    //diff(((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))/diff(ya) =
                    //  2*(y1 - ya)*((xi - x1)^2 - (yi - y1)^2)

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(ya) =
                    //  -(x1 - xa)*(xi - x1)*(yi - y1)

                    //diff(Pr(pi))/diff(ya) = -10*n/ln(10)*(-(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //  + 5*n/ln(10)*(2*(y1 - ya)*((xi - x1)^2 - (yi - y1)^2)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^4
                    //  + 20*n/ln(10)*(-(x1 - xa)*(xi - x1)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2)*-2(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^4

                    //diff(Pr(pi))/diff(ya) = -10*n/ln(10)*(-(yi - y1)*d1a^2 + ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*2*(y1 - ya))/d1a^4
                    //  + 5*n/ln(10)*(2*(y1 - ya)*((xi - x1)^2 - (yi - y1)^2)*d1a^4 + ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //  + 20*n/ln(10)*(-(x1 - xa)*(xi - x1)*(yi - y1)*d1a^4 + (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(y1 - ya))/d1a^8
<span class="fc" id="L1076">                    double derivativeYa = -10.0 * pathLossExponent / ln10 * (-diffYi1 * d1a2 + tmpY) / d1a4</span>
                            + 5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * (diffXi12 - diffYi12) * d1a4 + tmpY2) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffX1a * diffXi1 * diffYi1 * d1a4 + tmpY3) / d1a8;


                    //derivative of rssi respect to xi

                    //Pr(pi) = Pr(p1)
                    //  - 10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))
                    //  + 5*n*((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)
                    //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(xi) =
                    //  x1 - xa

                    //diff(((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))/diff(xi) =
                    //  2*((x1 - xa)^2 - (y1 - ya)^2)*(xi - x1)

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(xi) =
                    //  (x1 - xa)*(y1 - ya)*(yi - y1)

                    //diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*0)/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //  + 5*n/ln(10)*(2*((x1 - xa)^2 - (y1 - ya)^2)*(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2)^4
                    //  + 20*n/ln(10)*((x1 - xa)*(y1 - ya)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*0)/((x1 - xa)^2 + (y1 - ya)^2)^4

                    //diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*d1a^2)/d1a^4
                    //  + 5*n/ln(10)*(2*((x1 - xa)^2 - (y1 - ya)^2)*(xi - x1)*d1a^4)/d1a^8
                    //  + 20*n/ln(10)*((x1 - xa)*(y1 - ya)*(yi - y1)*d1a^4)/d1a^8

                    //diff(Pr(pi))/diff(xi) = -10*n/ln(10)*(x1 - xa)/d1a^2
                    //  + 10*n/ln(10)*(((x1 - xa)^2 - (y1 - ya)^2)*(xi - x1))/d1a^4
                    //  + 20*n/ln(10)*(x1 - xa)*(y1 - ya)*(yi - y1)/d1a^4
<span class="fc" id="L1108">                    double derivativeXi = -10.0 * pathLossExponent / ln10 * diffX1a / d1a2</span>
                            + 10.0 * pathLossExponent / ln10 * ((diffX1a2 - diffY1a2) * diffXi1) / d1a4
                            + 20.0 * pathLossExponent / ln10 * diffX1a * diffY1a * diffYi1 / d1a4;


                    //derivative of rssi respect to yi

                    //Pr(pi) = Pr(p1)
                    //  - 10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))
                    //  + 5*n*((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)
                    //  + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2))*(xi - x1)*(yi - y1)

                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))/diff(yi) =
                    //  y1 - ya

                    //diff(((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2))/diff(yi) =
                    //  2*((x1 - xa)^2 - (y1 - ya)^2)*(yi - y1)

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(yi) =
                    //  (x1 - xa)*(y1 - ya)*(xi - x1)

                    //diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*((x1 - xa)^2 + (y1 - ya)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1))*0)/((x1 - xa)^2 + (y1 - ya)^2)^2
                    //  + 5*n/ln(10)*(2*((x1 - xa)^2 - (y1 - ya)^2)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*((xi - x1)^2 - (yi - y1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2)^4
                    //  + 20*n/ln(10)*((x1 - xa)*(y1 - ya)*(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*0)/((x1 - xa)^2 + (y1 - ya)^2)^4

                    //diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*d1a^2)/d1a^4
                    //  + 5*n/ln(10)*(2*((x1 - xa)^2 - (y1 - ya)^2)*(yi - y1)*d1a^4)/d1a^8
                    //  + 20*n/ln(10)*((x1 - xa)*(y1 - ya)*(xi - x1)*d1a^4)/d1a^8

                    //diff(Pr(pi))/diff(yi) = -10*n/ln(10)*(y1 - ya)/d1a^2
                    //  + 10*n/ln(10)*(((x1 - xa)^2 - (y1 - ya)^2)*(yi - y1))/d1a^4
                    //  + 20*n/ln(10)*(x1 - xa)*(y1 - ya)*(xi - x1)/d1a^4
<span class="fc" id="L1140">                    double derivativeYi = -10.0 * pathLossExponent / ln10 * diffY1a / d1a2</span>
                            + 10.0 * pathLossExponent / ln10 * ((diffX1a2 - diffY1a2) * diffYi1) / d1a4
                            + 20.0 * pathLossExponent / ln10 * diffX1a * diffY1a * diffXi1 / d1a4;


                    //set derivatives fingerprintRssi, pathLossExponent, x1, y1, xa, ya, xi, yi
<span class="fc" id="L1146">                    jacobian.setElementAtIndex(0, derivativeFingerprintRssi);</span>
<span class="fc" id="L1147">                    jacobian.setElementAtIndex(1, derivativePathLossExponent);</span>
<span class="fc" id="L1148">                    jacobian.setElementAtIndex(2, derivativeX1);</span>
<span class="fc" id="L1149">                    jacobian.setElementAtIndex(3, derivativeY1);</span>
<span class="fc" id="L1150">                    jacobian.setElementAtIndex(4, derivativeXa);</span>
<span class="fc" id="L1151">                    jacobian.setElementAtIndex(5, derivativeYa);</span>
<span class="fc" id="L1152">                    jacobian.setElementAtIndex(6, derivativeXi);</span>
<span class="fc" id="L1153">                    jacobian.setElementAtIndex(7, derivativeYi);</span>
<span class="fc" id="L1154">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L1158">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L1161">        } catch (AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L1162">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (fingerprint rssi variance, path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * rssi variance by considering the 3D 1st order Taylor expression of received power.
     * Notice that any unknown variance is assumed to be zero.
     * @param fingerprintRssi closest located fingerprint reading RSSI expressed in dBm's.
     * @param pathLossExponent path-loss exponent.
     * @param fingerprintPosition position of closest fingerprint.
     * @param radioSourcePosition radio source position associated to fingerprint reading.
     * @param estimatedPosition  position to be estimated. Usually this is equal to the
     *                           initial position used by a non linear algorithm.
     * @param fingerprintRssiVariance variance of fingerprint RSSI or null if unknown.
     * @param pathLossExponentVariance variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance  covariance of position to be estimated or null
     *                                     if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiVarianceSecondOrderNonLinear3D(
            final double fingerprintRssi, final double pathLossExponent,
            Point3D fingerprintPosition, Point3D radioSourcePosition,
            Point3D estimatedPosition,
            Double fingerprintRssiVariance,
            Double pathLossExponentVariance,
            Matrix fingerprintPositionCovariance,
            Matrix radioSourcePositionCovariance,
            Matrix estimatedPositionCovariance) throws IndoorException {

<span class="fc bfc" id="L1198" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null ||</span>
                estimatedPosition == null) {
<span class="fc" id="L1200">            return null;</span>
        }

        //2nd order Taylor expression of received power in 3D:
        //Pr(pi) = Pr(p1)
        // - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
        // - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
        // - 10*n*(z1 - za)/(ln(10)*d1a^2)*(zi - z1)
        // - 5*n*((y1 - ya)^2 + (z1 - za)^2) - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2
        // - 5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*d1a^4)*(yi - y1)^2
        // - 5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*d1a^4)*(zi - z1)^2
        // + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4)*(xi - x1)*(yi - y1)
        // + 20*n*(y1 - ya)*(z1 - za)/(ln(10)*d1a^4)*(yi - y1)*(zi - z1)
        // + 20*n*(x1 - xa)*(z1 - za)/(ln(10)*d1a^4)*(xi - x1)*(zi - z1)
        //where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2

<span class="fc" id="L1216">        final double x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L1217">        final double y1 = fingerprintPosition.getInhomY();</span>
<span class="fc" id="L1218">        final double z1 = fingerprintPosition.getInhomZ();</span>

<span class="fc" id="L1220">        final double xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L1221">        final double ya = radioSourcePosition.getInhomY();</span>
<span class="fc" id="L1222">        final double za = radioSourcePosition.getInhomZ();</span>

<span class="fc" id="L1224">        final double xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L1225">        final double yi = estimatedPosition.getInhomY();</span>
<span class="fc" id="L1226">        final double zi = estimatedPosition.getInhomZ();</span>

<span class="fc" id="L1228">        double[] mean = new double[] {</span>
                fingerprintRssi, pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
        };
<span class="fc" id="L1231">        Matrix covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L1232" title="All 2 branches covered.">                fingerprintRssiVariance != null ? fingerprintRssiVariance : 0.0,</span>
<span class="fc bfc" id="L1233" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L1237" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L1238" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L1239" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L1241">            covariance.setSubmatrix(2, 2,</span>
                    4, 4,
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L1246" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L1247" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L1248" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L1249">            covariance.setSubmatrix(5, 5,</span>
                    7, 7,
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L1254" title="All 2 branches covered.">        if (estimatedPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L1255" title="1 of 2 branches missed.">                estimatedPositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L1256" title="1 of 2 branches missed.">                estimatedPositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L1257">            covariance.setSubmatrix(8, 8,</span>
                    10, 10,
                    estimatedPositionCovariance);
        }

        try {
<span class="fc" id="L1263">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(double[] x, double[] y, Matrix jacobian) {

                    //Pr(pi) = Pr(p1)
                    // - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    // - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
                    // - 10*n*(z1 - za)/(ln(10)*d1a^2)*(zi - z1)
                    // - 5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2
                    // - 5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*d1a^4)*(yi - y1)^2
                    // - 5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*d1a^4)*(zi - z1)^2
                    // + 20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4)*(xi - x1)*(yi - y1)
                    // + 20*n*(y1 - ya)*(z1 - za)/(ln(10)*d1a^4)*(yi - y1)*(zi - z1)
                    // + 20*n*(x1 - xa)*(z1 - za)/(ln(10)*d1a^4)*(xi - x1)*(zi - z1)
                    //where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2

                    //Hence:
                    //Pr(pi) = Pr(p1)
                    //  -10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(xi - x1)
                    //  -10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(yi - y1)
                    //  -10*n*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(zi - z1)
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //  +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //  +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

<span class="fc" id="L1291">                    double diffX1a = x1 - xa;</span>
<span class="fc" id="L1292">                    double diffY1a = y1 - ya;</span>
<span class="fc" id="L1293">                    double diffZ1a = z1 - za;</span>

<span class="fc" id="L1295">                    double diffXi1 = xi - x1;</span>
<span class="fc" id="L1296">                    double diffYi1 = yi - y1;</span>
<span class="fc" id="L1297">                    double diffZi1 = zi - z1;</span>

<span class="fc" id="L1299">                    double diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L1300">                    double diffY1a2 = diffY1a * diffY1a;</span>
<span class="fc" id="L1301">                    double diffZ1a2 = diffZ1a * diffZ1a;</span>

<span class="fc" id="L1303">                    double diffXi12 = diffXi1 * diffXi1;</span>
<span class="fc" id="L1304">                    double diffYi12 = diffYi1 * diffYi1;</span>
<span class="fc" id="L1305">                    double diffZi12 = diffZi1 * diffZi1;</span>

<span class="fc" id="L1307">                    double d1a2 = diffX1a2 + diffY1a2 + diffZ1a2;</span>
<span class="fc" id="L1308">                    double d1a4 = d1a2 * d1a2;</span>
<span class="fc" id="L1309">                    double d1a8 = d1a4 * d1a4;</span>

<span class="fc" id="L1311">                    double ln10 = Math.log(10.0);</span>
<span class="fc" id="L1312">                    double crossDiff = diffX1a * diffXi1 + diffY1a * diffYi1 + diffZ1a * diffZi1;</span>

                    //Pr(pi) = Pr(p1)
                    //  -10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(xi - x1)
                    //  -10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(yi - y1)
                    //  -10*n*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(zi - z1)
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //  +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //  +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

<span class="fc" id="L1325">                    y[0] = fingerprintRssi</span>
                            - 10.0 * pathLossExponent * diffX1a / (ln10 * d1a2) * diffXi1
                            - 10.0 * pathLossExponent * diffY1a / (ln10 * d1a2) * diffYi1
                            - 10.0 * pathLossExponent * diffZ1a / (ln10 * d1a2) * diffZi1
                            - 5.0 * pathLossExponent * (-diffX1a2 + diffY1a2 + diffZ1a2) / (ln10 * d1a4) * diffXi12
                            - 5.0 * pathLossExponent * (diffX1a2 - diffY1a2 + diffZ1a2) / (ln10 * d1a4) * diffYi12
                            - 5.0 * pathLossExponent * (diffX1a2 + diffY1a2 - diffZ1a2) / (ln10 * d1a4) * diffZi12
                            + 20.0 * pathLossExponent * diffX1a * diffY1a / (ln10 * d1a4) * diffXi1 * diffYi1
                            + 20.0 * pathLossExponent * diffY1a * diffZ1a / (ln10 * d1a4) * diffYi1 * diffZi1
                            + 20.0 * pathLossExponent * diffX1a * diffZ1a / (ln10 * d1a4) * diffXi1 * diffZi1;

                    //compute gradient (is a jacobian having 1 row and 11 columns)


                    //derivative of rssi respect to fingerprint rssi
<span class="fc" id="L1340">                    double derivativeFingerprintRssi = 1.0;</span>

                    //derivative of rssi respect to path-loss exponent

                    //diff(Pr(pi))/diff(n) = -10*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //  -10*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
<span class="fc" id="L1346">                    double derivativePathLossExponent = - 10.0 * diffX1a / (ln10 * d1a2) * diffXi1</span>
                            - 10.0 * diffY1a / (ln10 * d1a2) * diffYi1
                            - 10.0 * diffZ1a / (ln10 * d1a2) * diffZi1
                            - 5.0 * (-diffX1a2 + diffY1a2 + diffZ1a2) / (ln10 * d1a4) * diffXi12
                            - 5.0 * (diffX1a2 - diffY1a2 + diffZ1a2) / (ln10 * d1a4) * diffYi12
                            - 5.0  * (diffX1a2 + diffY1a2 - diffZ1a2) / (ln10 * d1a4) * diffZi12
                            + 20.0 * diffX1a * diffY1a / (ln10 * d1a4) * diffXi1 * diffYi1
                            + 20.0 * diffY1a * diffZ1a / (ln10 * d1a4) * diffYi1 * diffZi1
                            + 20.0 * diffX1a * diffZ1a / (ln10 * d1a4) * diffXi1 * diffZi1;


                    //derivative of rssi respect to x1

                    //We have
                    //Pr(pi) = Pr(p1)
                    //  -10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(xi - x1)
                    //  -10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(yi - y1)
                    //  -10*n*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*(zi - z1)
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //  +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //  +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    //Pr(pi) = Pr(p1)
                    //  -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //  +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //  +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)


                    //and we know that: (f(x)/g(x))' = (f'(x)*g(x) - f(x)*g'(x))/g(x)^2
                    //and also that (f(x)*g(x))' = f'(x)*g(x) + f(x)*g'(x)

                    //Hence
                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(x1) =
                    //  diff(x1*xi -xa*xi -x1^2 + xa*x1)/diff(x1) =
                    //  diff(-x1^2 + (xi + xa)*x1 - xa*xi)/diff(x1) =
                    //  -2*x1 + xi + xa

                    //diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(x1) =
                    //  diff(-(x1 - xa)^2*(xi - x1)^2)/diff(x1) =
                    //  -2*(x1 - xa)*(xi - x1)^2 - 2*(xi - x1)*(-(x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)
                    //  -2*((x1 - xa)*(xi - x1)^2 + (xi - x1)*(-(x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

                    //diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(x1) =
                    //  diff((x1 - xa)^2*(yi - y1)^2)/diff(x1) =
                    //  2*(x1 - xa)*(yi - y1)^2

                    //diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(z1 - za)^2)/diff(x1) =
                    //  diff((x1 - xa)^2*(z1 - za)^2)/diff(x1) =
                    //  2*(x1 - xa)*(z1 - za)^2

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(x1) =
                    //  (y1 - ya)*(yi - y1)*((xi - x1) - (x1 - xa)) =
                    //  (y1 - ya)*(yi - y1)*(-2*x1 + xi + xa)

                    //diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(x1) = 0

                    //diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(x1) =
                    //  (z1 - za)*(zi - z1)*((xi - x1) - (x1 - xa)) =
                    //  (z1 - za)*(zi - z1)*(-2*x1 + xi + xa)

                    //diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //  -5*n/ln(10)*(-2*((x1 - xa)*(xi - x1)^2 + (xi - x1)*(-(x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(2*(x1 - xa)*(yi - y1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(2*(x1 - xa)*(z1 - za)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(z1 - za)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*((y1 - ya)*(yi - y1)*(-2*x1 + xi + xa)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*((z1 - za)*(zi - z1)*(-2*x1 + xi + xa)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    //diff(Pr(pi))/diff(x1) = -10*n/ln(10)*((-2*x1 + xi + xa)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(x1 - xa))/d1a^4
                    //  -5*n/ln(10)*(-2*((x1 - xa)*(xi - x1)^2 + (xi - x1)*(-(x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*d1a^4 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //  -5*n/ln(10)*(2*(x1 - xa)*(yi - y1)^2*d1a^4 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //  -5*n/ln(10)*(2*(x1 - xa)*(z1 - za)^2*d1a^4 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(z1 - za)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //  +20*n/ln(10)*((y1 - ya)*(yi - y1)*(-2*x1 + xi + xa)*d1a^4 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(x1 - xa))/d1a^8
                    //  +20*n/ln(10)*(-(y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*4*d1a^2*(x1 - xa))/d1a^8
                    //  +20*n/ln(10)*((z1 - za)*(zi - z1)*(-2*x1 + xi + xa)*d1a^4 - (x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1)*4*d1a^2*(x1 - xa))/d1a^8
<span class="fc" id="L1428">                    double tmp1 = (diffY1a2 + diffZ1a2 - diffX1a2) * diffXi12 * 4.0 * d1a2 * diffX1a;</span>
<span class="fc" id="L1429">                    double tmp2 = diffX1a * diffY1a * diffXi1 * diffYi1 * 4.0 * d1a2 * diffX1a;</span>
<span class="fc" id="L1430">                    double tmp3 = diffX1a * diffZ1a * diffXi1 * diffZi1 * 4.0 * d1a2 * diffX1a;</span>
<span class="fc" id="L1431">                    double derivativeX1 = -10.0 * pathLossExponent / ln10 * ((-2*x1 + xi + xa)*d1a2 - crossDiff * 2.0 * diffX1a) / d1a4</span>
                            - 5.0 * pathLossExponent / ln10 * (-2.0 * (diffX1a * diffXi12 + diffXi1 * (-diffX1a2 + diffY1a2 + diffZ1a2)) * d1a4 - tmp1) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffX1a * diffYi12 * d1a4 - tmp1) / d1a8
                            - 5.0 * pathLossExponent / ln10 * (2.0 * diffX1a * diffZ1a2 * d1a4 - (diffX1a2 + diffY1a2 - diffZ1a2) * diffZ1a2 * 4.0 * d1a2 * diffX1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (diffY1a * diffYi1 * (-2.0 * x1 + xi + xa) * d1a4 - tmp2) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (-diffY1a * diffZ1a * diffYi1 * diffZi1 * 4.0 * d1a2 * diffX1a) / d1a8
                            + 20.0 * pathLossExponent / ln10 * (diffZ1a * diffZi1 * (-2.0 * x1 + xi + xa) * d1a4 - tmp3) / d1a8;



                    //derivative of rssi respect to y1

                    //We have
                    //Pr(pi) = Pr(p1)
                    //  -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //  +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //  +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    //Hence
                    //diff((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/diff(y1) =
                    //  diff(y1*yi - ya*yi -y1^2 + ya*y1)/diff(y1) =
                    //  diff(-y1^2 + (yi + ya)*y1 - ya*yi)/diff(y1) =
                    //  -2*y1 + yi + ya

                    //diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(y1) =
                    //  2*(y1 - ya)*(xi - x1)^2

                    //diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(y1) =
                    //  -2*(y1 - ya)*(yi - y1)^2 -2*(yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)
                    //  -2*((y1 - ya)*(yi - y1)^2 + (yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2))

                    //diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(y1) =
                    //  2*(y1 - ya)*(zi - z1)^2

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(y1) =
                    //  (x1 - xa)*(xi - x1)*(yi - y1) - (xi - x1)*(x1 - xa)*(y1 - ya) =
                    //  (x1 - xa)*((xi - x1)*(yi - y1) - (xi - x1)*(y1 - ya)) =
                    //  (x1 - xa)*(xi - x1)*(-2*y1 + yi + ya)

                    //diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(y1) =
                    //  (z1 - za)*(yi - y1)*(zi - z1) - (zi - z1)*(y1 - ya)*(z1 - za) =
                    //  (z1 - za)*((yi - y1)*(zi - z1) - (zi - z1)*(y1 - ya)) =
                    //  (z1 - za)*(zi - z1)*(-2*y1 + yi + ya)

                    //diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(y1) = 0

                    //diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //  -5*n/ln(10)*(2*(y1 - ya)*(xi - x1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(-2*((y1 - ya)*(yi - y1)^2 + (yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2))*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2*2((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2(y1 -ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(2*(y1 - ya)*(zi - z1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*((x1 - xa)*(xi - x1)*(-2*y1 + yi + ya)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*((z1 - za)*(zi - z1)*(-2*y1 + yi + ya)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    //diff(Pr(pi))/diff(y1) = -10*n/ln(10)*((-2*y1 + yi + ya)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(y1 - ya))/d1a^4
                    //  -5*n/ln(10)*(2*(y1 - ya)*(xi - x1)^2*d1a^4 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //  -5*n/ln(10)*(-2*((y1 - ya)*(yi - y1)^2 + (yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2))*d1a^4 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*4*d1a^2*(y1 -ya))/d1a^8
                    //  -5*n/ln(10)*(2*(y1 - ya)*(zi - z1)^2*d1a^4 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //  +20*n/ln(10)*((x1 - xa)*(xi - x1)*(-2*y1 + yi + ya)*d1a^4 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(y1 - ya))/d1a^8
                    //  +20*n/ln(10)*((z1 - za)*(zi - z1)*(-2*y1 + yi + ya)*d1a^4 - (y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*4*d1a^2*(y1 - ya))/d1a^8
                    //  +20*n/ln(10)*(-(x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1)*4*d1a^2*(y1 - ya))/d1a^8
<span class="fc" id="L1496">                    double tmp4 = diffY1a * diffZ1a * diffYi1 * diffZi1 * 4.0 * d1a2 * diffY1a;</span>
<span class="fc" id="L1497">                    double derivativeY1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * y1 + yi + ya) * d1a2 - crossDiff * 2.0 * diffY1a) / d1a4</span>
                        - 5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * diffXi12 * d1a4 - (-diffX1a2 + diffY1a2 + diffZ1a2) * diffXi12 * 4.0 * d1a2 * diffY1a) / d1a8
                        - 5.0 * pathLossExponent / ln10 * (-2.0 * (diffY1a * diffYi12 + diffYi1 * (diffX1a2 - diffY1a2 + diffZ1a2)) * d1a4 - (diffX1a2 - diffY1a2 + diffZ1a2) * diffYi12 * 4.0 * d1a2 * diffY1a) / d1a8
                        - 5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * diffZi12 * d1a4 - (diffX1a2 + diffY1a2 - diffZ1a2) * diffZi12 * 4.0 * d1a2 * diffY1a) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (diffX1a * diffXi1 * (-2.0 * y1 + yi + ya) * d1a4 - diffX1a * diffY1a * diffXi1 * diffYi1 * 4.0 * d1a2 * diffY1a) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (diffZ1a * diffZi1 * (-2.0 * y1 + yi + ya) * d1a4 - tmp4) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (-diffX1a * diffZ1a * diffXi1 * diffZi1 * 4.0 * d1a2 * diffY1a) / d1a8;


                    //derivative of rssi respect to z1

                    //We have
                    //Pr(pi) = Pr(p1)
                    //  -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //  +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //  +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    //Hence
                    //diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(z1) =
                    //  diff(z1*zi -za*zi -z1^2 + za*z1)/diff(z1) =
                    //  diff(-z1^2 + (zi + za)*z1 - za*zi)/diff(z1) =
                    //  -2*z1 + zi + za

                    //diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(z1) =
                    //  2*(z1 - za)*(xi - x1)^2

                    //diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(z1) =
                    //  2*(z1 - za)*(yi - y1)^2

                    //diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(z1) =
                    //  2*(z1 - za)*(zi - z1)^2 + 2*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)
                    //  2*((z1 - za)*(zi - z1)^2 + (zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2))

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(z1) = 0

                    //diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(z1) =
                    //  (y1 - ya)*(yi - y1)*(zi - z1) - (yi - y1)*(y1 - ya)*(z1 - za) =
                    //  (y1 - ya)*((yi - y1)*(zi - z1) - (yi - y1)*(z1 - za)) =
                    //  (y1 - ya)*(yi - y1)*(-2*z1 + zi + za)

                    //diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(z1) =
                    //  (x1 - xa)*(xi - x1)*(zi - z1) - (xi - x1)*(x1 - xa)*(z1 - za) =
                    //  (x1 - xa)*((xi - x1)*(zi - z1) - (xi - x1)*(z1 - za)) =
                    //  (x1 - xa)*(xi - x1)*(-2*z1 + zi + za)

                    //diff(Pr(pi))/diff(z1) = -10*n/ln(10)*((-2*z1 + zi + za)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //  -5*n/ln(10)*(2*(z1 - za)*(xi - x1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(2*(z1 - za)*(yi - y1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(2*((z1 - za)*(zi - z1)^2 + (zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2))*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2 - ((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*((y1 - ya)*(yi - y1)*(-2*z1 + zi + za)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*((x1 - xa)*(xi - x1)*(-2*z1 + zi + za)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    //diff(Pr(pi))/diff(z1) = -10*n/ln(10)*((-2*z1 + zi + za)*d1a^2 - ((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))*2*(z1 - za))/d1a^4
                    //  -5*n/ln(10)*(2*(z1 - za)*(xi - x1)^2*d1a^4 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(z1 - za))/d1a^8
                    //  -5*n/ln(10)*(2*(z1 - za)*(yi - y1)^2*d1a^4 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*4*d1a^2*(z1 - za))/d1a^8
                    //  -5*n/ln(10)*(2*((z1 - za)*(zi - z1)^2 + (zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2))*d1a^4 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*4*d1a^2*(z1 - za))/d1a^8
                    //  +20*n/ln(10)*(-(x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(z1 - za))/d1a^8
                    //  +20*n/ln(10)*((y1 - ya)*(yi - y1)*(-2*z1 + zi + za)*d1a^4 - ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*4*d1a^2*(z1 - za))/d1a^8
                    //  +20*n/ln(10)*((x1 - xa)*(xi - x1)*(-2*z1 + zi + za)*d1a^4 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*4*d1a^2*(z1 - za))/d1a^8
<span class="fc" id="L1561">                    double derivativeZ1 = -10.0 * pathLossExponent / ln10 * ((-2.0 * z1 + zi + za) * d1a2 - crossDiff * 2.0 * diffZ1a) / d1a4</span>
                        - 5.0 * pathLossExponent / ln10 * (2.0 * diffZ1a * diffXi12 * d1a4 - ((- diffX1a2 + diffY1a2 + diffZ1a2) * diffXi12) * 4.0 * d1a2 * diffZ1a) / d1a8
                        - 5.0 * pathLossExponent / ln10 * (2.0 * diffZ1a * diffYi12 * d1a4 - ((diffX1a2 - diffY1a2 + diffZ1a2)*diffYi12) * 4.0 * d1a2 * diffZ1a) / d1a8
                        - 5.0 * pathLossExponent / ln10 *(2.0 * (diffZ1a * diffZi12 + diffZi1 * (diffX1a2 + diffY1a2 - diffZ1a2)) * d1a4 - ((diffX1a2 + diffY1a2 - diffZ1a2) * diffZi12) * 4.0 * d1a2 * diffZ1a) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (-diffX1a * diffY1a * diffXi1 * diffYi1 * 4.0 * d1a2 * diffZ1a) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (diffY1a * diffYi1 * (-2.0 * z1 + zi + za) * d1a4 - diffY1a * diffZ1a * diffYi1 * diffZi1 * 4.0 * d1a2 * diffZ1a) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (diffX1a * diffXi1 * (-2.0 * z1 + zi + za) * d1a4 - diffX1a * diffZ1a * diffXi1 * diffZi1 * 4.0 * d1a2 * diffZ1a) / d1a8;


                    //derivative of rssi respect to xa

                    //We have
                    //Pr(pi) = Pr(p1)
                    //  -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //  +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //  +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    //Hence
                    //diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(xa) =
                    //  -(xi - x1)

                    //diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(xa) =
                    //  2*(x1 - xa)*(xi - x1)^2

                    //diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(xa) =
                    //  -2*(x1 - xa)*(yi - y1)^2

                    //diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(xa) =
                    //  -2*(x1 - xa)*(zi - z1)^2

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(xa) =
                    //  -(y1 - ya)*(xi - x1)*(yi - y1)

                    //diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(xa) = 0

                    //diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(xa) =
                    //  -(z1 - za)*(xi - x1)*(zi - z1)

                    //diff(Pr(pi))/diff(xa) = -10*n/ln(10)*(-(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //  -5*n/ln(10)*(2*(x1 - xa)*(xi - x1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(-2*(x1 - xa)*(yi - y1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(-2*(x1 - xa)*(zi - z1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(-(y1 - ya)*(xi - x1)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(-(z1 - za)*(xi - x1)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    //diff(Pr(pi))/diff(xa) = -10*n/ln(10)*(-(xi - x1)*d1a^2 + (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*2*(x1 - xa))/d1a^4
                    //  -5*n/ln(10)*(2*(x1 - xa)*(xi - x1)^2*d1a^4 + (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //  -5*n/ln(10)*(-2*(x1 - xa)*(yi - y1)^2*d1a^4 + (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //  -5*n/ln(10)*(-2*(x1 - xa)*(zi - z1)^2*d1a^4 + (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*4*d1a^2*(x1 - xa))/d1a^8
                    //  +20*n/ln(10)*(-(y1 - ya)*(xi - x1)*(yi - y1)*d1a^4 + (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*4*d1a^2*(x1 - xa))/d1a^8
                    //  +20*n/ln(10)*((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*4*d1a^2*(x1 - xa))/d1a^8
                    //  +20*n/ln(10)*(-(z1 - za)*(xi - x1)*(zi - z1)*d1a^4 + (x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1)*4*d1a^2*(x1 - xa))/d1a^8
<span class="fc" id="L1618">                    double derivativeXa = - 10.0 * pathLossExponent / ln10 * (-diffXi1 * d1a2 + crossDiff * 2.0 * diffX1a) / d1a4</span>
                        -5.0 * pathLossExponent / ln10 * (2.0 * diffX1a * diffXi12 * d1a4 + ((diffY1a2 + diffZ1a2 - diffX1a2) * diffXi12) * 4.0 * d1a2 * diffX1a) / d1a8
                        -5.0 * pathLossExponent / ln10 * (-2.0 * diffX1a * diffYi12 * d1a4 + ((diffX1a2 - diffY1a2 + diffZ1a2) * diffYi12) * 4.0 * d1a2 * diffX1a) / d1a8
                        -5.0 * pathLossExponent / ln10 * (-2.0 * diffX1a * diffZi12 * d1a4 + ((diffX1a2 + diffY1a2 - diffZ1a2) * diffZi12) * 4.0 * d1a2 * diffX1a) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (-diffY1a * diffXi1 * diffYi1 * d1a4 + tmp2) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (diffY1a * diffZ1a * diffYi1 * diffZi1 * 4.0 * d1a2 * diffX1a) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (-diffZ1a * diffXi1 * diffZi1 * d1a4 + tmp3) / d1a8;


                    //derivative of rssi respect to ya

                    //We have
                    //Pr(pi) = Pr(p1)
                    //  -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //  +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //  +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    //Hence
                    //diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(ya) =
                    //  -(yi - y1)

                    //diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(ya) =
                    //  -2*(y1 - ya)*(xi - x1)^2

                    //diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(ya) =
                    //  2*(y1 - ya)*(yi - y1)^2

                    //diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(ya) =
                    //  -2*(y1 - ya)*(zi - z1)^2

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(ya) =
                    //  -(x1 - xa)*(xi - x1)*(yi - y1)

                    //diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(ya) =
                    //  -(z1 - za)*(yi - y1)*(zi - z1)

                    //diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(ya) = 0

                    //diff(Pr(pi))/diff(ya) = -10*n/ln(10)*(-(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //  -5*n/ln(10)*(-2*(y1 - ya)*(xi - x1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(2*(y1 - ya)*(yi - y1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(-2*(y1 - ya)*(zi - z1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(-(x1 - xa)*(xi - x1)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(-(z1 - za)*(yi - y1)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    //diff(Pr(pi))/diff(ya) = -10*n/ln(10)*(-(yi - y1)*d1a^2 + (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*2*(y1 - ya))/d1a^4
                    //  -5*n/ln(10)*(-2*(y1 - ya)*(xi - x1)^2*d1a^4 + (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //  -5*n/ln(10)*(2*(y1 - ya)*(yi - y1)^2*d1a^4 + (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //  -5*n/ln(10)*(-2*(y1 - ya)*(zi - z1)^2*d1a^4 + (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*4*d1a^2*(y1 - ya))/d1a^8
                    //  +20*n/ln(10)*(-(x1 - xa)*(xi - x1)*(yi - y1)*d1a^4 + ((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*4*d1a^2*(y1 - ya))/d1a^8
                    //  +20*n/ln(10)*(-(z1 - za)*(yi - y1)*(zi - z1)*d1a^4 + (y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1)*4*d1a^2*(y1 - ya))/d1a^8
                    //  +20*n/ln(10)*(((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*4*d1a^2*(y1 - ya))/d1a^8
<span class="fc" id="L1675">                    double derivativeYa = -10.0 * pathLossExponent / ln10 * (-diffYi1 * d1a2 + crossDiff * 2.0 * diffY1a) / d1a4</span>
                        - 5.0 * pathLossExponent / ln10 * (-2.0 * diffY1a * diffXi12 * d1a4 + ((diffY1a2 + diffZ1a2 - diffX1a2) * diffXi12) * 4.0 * d1a2 * diffY1a) / d1a8
                        - 5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * diffYi12 * d1a4 + ((diffX1a2 - diffY1a2 + diffZ1a2) * diffYi12) * 4.0 * d1a2 * diffY1a) / d1a8
                        - 5.0 * pathLossExponent / ln10 * (-2.0 * diffY1a * diffZi12 * d1a4 + ((diffX1a2 + diffY1a2 - diffZ1a2) * diffZi12) * 4.0 * d1a2 * diffY1a) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (-diffX1a * diffXi1 * diffYi1 * d1a4 + (diffX1a * diffY1a * diffXi1 * diffYi1) * 4.0 * d1a2 * diffY1a) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (-diffZ1a * diffYi1 * diffZi1 * d1a4 + tmp4) / d1a8
                        + 20.0 * pathLossExponent / ln10 * ((diffX1a * diffZ1a * diffXi1 * diffZi1) * 4.0 * d1a2 * diffY1a) / d1a8;


                    //derivative of rssi respect to za

                    //We have
                    //Pr(pi) = Pr(p1)
                    //  -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //  +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //  +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    //Hence
                    //diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(za) =
                    //  -(zi - z1)

                    //diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(za) =
                    //  -2*(z1 - za)*(xi - x1)^2

                    //diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(za) =
                    //  -2*(z1 - za)*(yi - y1)^2

                    //diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(za) =
                    //  2*(z1 - za)*(zi - z1)^2

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(za) = 0

                    //diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(za) =
                    //  -(y1 - ya)*(yi - y1)*(zi - z1)

                    //diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(za) =
                    //  -(x1 - xa)*(xi - x1)*(zi - z1)

                    //diff(Pr(pi))/diff(za) = -10*n/ln(10)*(-(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //  -5*n/ln(10)*(-2*(z1 - za)*(xi - x1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(-2*(z1 - za)*(yi - y1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(2*(z1 - za)*(zi - z1)^2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(-(y1 - ya)*(yi - y1)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(-(x1 - xa)*(xi - x1)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*2*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)*-2*(z1 - za))/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    //diff(Pr(pi))/diff(za) = -10*n/ln(10)*(-(zi - z1)*d1a^2 + (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*2*(z1 - za))/d1a^4
                    //  -5*n/ln(10)*(-2*(z1 - za)*(xi - x1)^2*d1a^4 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*4*d1a^2*(z1 - za))/d1a^8
                    //  -5*n/ln(10)*(-2*(z1 - za)*(yi - y1)^2*d1a^4 + (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*4*d1a^2*(z1 - za))/d1a^8
                    //  -5*n/ln(10)*(2*(z1 - za)*(zi - z1)^2*d1a^4 + (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*4*d1a^2*(z1 - za))/d1a^8
                    //  +20*n/ln(10)*(((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*4*d1a^2*(z1 - za))/d1a^8
                    //  +20*n/ln(10)*(-(y1 - ya)*(yi - y1)*(zi - z1)*d1a^4 + ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*4*d1a^2*(z1 - za))/d1a^8
                    //  +20*n/ln(10)*(-(x1 - xa)*(xi - x1)*(zi - z1)*d1a^4 + ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*4*d1a^2*(z1 - za))/d1a^8
<span class="fc" id="L1732">                    double derivativeZa = - 10.0 * pathLossExponent / ln10 *(-diffZi1 * d1a2 + crossDiff * 2.0 * diffZ1a) / d1a4</span>
                        - 5.0 * pathLossExponent / ln10 * (-2.0 * diffZ1a * diffXi12 * d1a4 - (-diffX1a2 + diffY1a2 + diffZ1a2) * diffXi12 * 4.0 * d1a2 * diffZ1a) / d1a8
                        - 5.0 * pathLossExponent / ln10 * (-2.0 * diffZ1a * diffYi12 * d1a4 + (diffX1a2 - diffY1a2 + diffZ1a2)*diffYi12 * 4.0 * d1a2 * diffZ1a) / d1a8
                        - 5.0 * pathLossExponent / ln10 * (2.0 * diffZ1a * diffZi12 * d1a4 + (diffX1a2 + diffY1a2 - diffZ1a2) * diffZi12 * 4.0 * d1a2 * diffZ1a) / d1a8
                        + 20.0 * pathLossExponent / ln10 * ((diffX1a * diffY1a * diffXi1 * diffYi1) * 4.0 * d1a2 * diffZ1a) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (-diffY1a * diffYi1 * diffZi1 * d1a4 + (diffY1a * diffZ1a * diffYi1 * diffZi1) * 4.0 * d1a2 * diffZ1a) / d1a8
                        + 20.0 * pathLossExponent / ln10 * (-diffX1a * diffXi1 * diffZi1 * d1a4 + (diffX1a * diffZ1a * diffXi1 * diffZi1) * 4.0 * d1a2 * diffZ1a) / d1a8;


                    //derivative of rssi respect to xi

                    //We have
                    //Pr(pi) = Pr(p1)
                    //  -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //  +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //  +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    //Hence
                    //diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(xi) =
                    //  x1 - xa

                    //diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(xi) =
                    //  2*(xi - x1)*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)

                    //diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(xi) = 0

                    //diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(xi) = 0

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(xi) =
                    //  (x1 - xa)*(y1 - ya)*(yi - y1)

                    //diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(xi) = 0

                    //diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(xi) =
                    //  (x1 - xa)*(z1 - za)*(zi - z1)

                    //diff(Pr(pi))/diff(xi) = -10*n/ln(10)*((x1 - xa)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //  -5*n/ln(10)*(2*(xi - x1)*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*((x1 - xa)*(y1 - ya)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*((x1 - xa)*(z1 - za)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    //diff(Pr(pi))/diff(xi) = -10*n/ln(10)*(x1 - xa)*d1a^2/d1a^4
                    //  -5*n/ln(10)*(2*(xi - x1)*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*d1a^4)/d1a^8
                    //  +20*n/ln(10)*(x1 - xa)*(y1 - ya)*(yi - y1)*d1a^4/d1a^8
                    //  +20*n/ln(10)*(x1 - xa)*(z1 - za)*(zi - z1)*d1a^4)/d1a^8

                    //diff(Pr(pi))/diff(xi) = -10*n/ln(10)*(x1 - xa)/d1a^2
                    //  -10*n/ln(10)*(xi - x1)*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/d1a^4
                    //  +20*n/ln(10)*(x1 - xa)*(y1 - ya)*(yi - y1)/d1a^4
                    //  +20*n/ln(10)*(x1 - xa)*(z1 - za)*(zi - z1)/d1a^4
<span class="fc" id="L1789">                    double derivativeXi = -10.0 * pathLossExponent / ln10 * diffX1a / d1a2</span>
                        - 10.0 * pathLossExponent / ln10 * diffXi1 * (-diffX1a2 + diffY1a2 + diffZ1a2) / d1a4
                        + 20.0 * pathLossExponent / ln10 * diffX1a * diffY1a * diffYi1 / d1a4
                        + 20.0 * pathLossExponent / ln10 * diffX1a * diffZ1a * diffZi1 / d1a4;


                    //derivative of rssi respect to yi

                    //We have
                    //Pr(pi) = Pr(p1)
                    //  -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //  +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //  +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    //Hence
                    //diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(yi) =
                    //  y1 - ya

                    //diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(yi) = 0

                    //diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(yi) =
                    //  2*(yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)

                    //diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(yi) = 0

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(yi) =
                    //  (x1 - xa)*(y1 - ya)*(xi - x1)

                    //diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(yi) =
                    //  (y1 - ya)*(z1 - za)*(zi - z1)

                    //diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(yi) = 0

                    //diff(Pr(pi))/diff(yi) = -10*n/ln(10)*((y1 - ya)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //  -5*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(2*(yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*((x1 - xa)*(y1 - ya)*(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*((y1 - ya)*(z1 - za)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  +20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    //diff(Pr(pi))/diff(yi) = -10*n/ln(10)*(y1 - ya)*d1a^2/d1a^4
                    //  -5*n/ln(10)*(2*(yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*d1a^4)/d1a^8
                    //  +20*n/ln(10)*((x1 - xa)*(y1 - ya)*(xi - x1)*d1a^4)/d1a^8
                    //  +20*n/ln(10)*((y1 - ya)*(z1 - za)*(zi - z1)*d1a^4)/d1a^8

                    //diff(Pr(pi))/diff(yi) = -10*n/ln(10)*(y1 - ya)/d1a^2
                    //  -10*n/ln(10)*(yi - y1)*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/d1a^4
                    //  +20*n/ln(10)*(x1 - xa)*(y1 - ya)*(xi - x1)/d1a^4
                    //  +20*n/ln(10)*(y1 - ya)*(z1 - za)*(zi - z1)/d1a^4
<span class="fc" id="L1843">                    double derivativeYi = -10.0 * pathLossExponent / ln10 * diffY1a / d1a2</span>
                        - 10.0 * pathLossExponent / ln10 * diffYi1 * (diffX1a2 - diffY1a2 + diffZ1a2) / d1a4
                        + 20.0 * pathLossExponent / ln10 * diffX1a * diffY1a * diffXi1 / d1a4
                        + 20.0 * pathLossExponent / ln10 * diffY1a * diffZ1a * diffZi1 / d1a4;


                    //derivative of rssi respect to zi

                    //We have
                    //Pr(pi) = Pr(p1)
                    //  -10*n*((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1))/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)^2
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(zi - z1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(yi - y1)
                    //  +20*n*(y1 - ya)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(yi - y1)*(zi - z1)
                    //  +20*n*(x1 - xa)*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2)*(xi - x1)*(zi - z1)

                    //Hence
                    //diff(((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))/diff(zi) =
                    //  z1 - za

                    //diff(((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)/diff(zi) = 0

                    //diff(((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)/diff(zi) = 0

                    //diff(((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)/diff(zi) =
                    //  2*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)

                    //diff((x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1))/diff(zi) = 0

                    //diff((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))/diff(zi) =
                    //  (y1 - ya)*(z1 - za)*(yi - y1)

                    //diff((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))/diff(zi) =
                    //  (x1 - xa)*(z1 - za)*(xi - x1)

                    //diff(Pr(pi))/diff(zi) = -10*n/ln(10)*((z1 - za)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - (((x1 - xa)*(xi - x1) + (y1 - ya)*(yi - y1) + (z1 - za)*(zi - z1)))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2
                    //  -5*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*(xi - x1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*(yi - y1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  -5*n/ln(10)*(2*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*(zi - z1)^2)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  20*n/ln(10)*(0*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - (x1 - xa)*(y1 - ya)*(xi - x1)*(yi - y1)*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  20*n/ln(10)*((y1 - ya)*(z1 - za)*(yi - y1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((y1 - ya)*(z1 - za)*(yi - y1)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4
                    //  20*n/ln(10)*((x1 - xa)*(z1 - za)*(xi - x1)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^2 - ((x1 - xa)*(z1 - za)*(xi - x1)*(zi - z1))*0)/((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)^4

                    //diff(Pr(pi))/diff(zi) = -10*n/ln(10)*((z1 - za)*d1a^2)/d1a^4
                    //  -5*n/ln(10)*(2*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*d1a^4)/d1a^8
                    //  20*n/ln(10)*((y1 - ya)*(z1 - za)*(yi - y1)*d1a^4)/d1a^8
                    //  20*n/ln(10)*((x1 - xa)*(z1 - za)*(xi - x1)*d1a^4)/d1a^8

                    //diff(Pr(pi))/diff(zi) = -10*n/ln(10)*(z1 - za)/d1a^2
                    //  -10*n/ln(10)*(zi - z1)*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/d1a^4
                    //  20*n/ln(10)*(y1 - ya)*(z1 - za)*(yi - y1)/d1a^4
                    //  20*n/ln(10)*(x1 - xa)*(z1 - za)*(xi - x1)/d1a^4
<span class="fc" id="L1897">                    double derivativeZi = -10.0 * pathLossExponent / ln10 * diffZ1a / d1a2</span>
                        - 10.0 * pathLossExponent / ln10 * diffZi1 * (diffX1a2 + diffY1a2 - diffZ1a2) / d1a4
                        + 20.0 * pathLossExponent / ln10 * diffY1a * diffZ1a * diffYi1 / d1a4
                        + 20.0 * pathLossExponent / ln10 * diffX1a * diffZ1a * diffXi1 / d1a4;


                    //set derivatives fingerprintRssi, pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
<span class="fc" id="L1904">                    jacobian.setElementAtIndex(0, derivativeFingerprintRssi);</span>
<span class="fc" id="L1905">                    jacobian.setElementAtIndex(1, derivativePathLossExponent);</span>
<span class="fc" id="L1906">                    jacobian.setElementAtIndex(2, derivativeX1);</span>
<span class="fc" id="L1907">                    jacobian.setElementAtIndex(3, derivativeY1);</span>
<span class="fc" id="L1908">                    jacobian.setElementAtIndex(4, derivativeZ1);</span>
<span class="fc" id="L1909">                    jacobian.setElementAtIndex(5, derivativeXa);</span>
<span class="fc" id="L1910">                    jacobian.setElementAtIndex(6, derivativeYa);</span>
<span class="fc" id="L1911">                    jacobian.setElementAtIndex(7, derivativeZa);</span>
<span class="fc" id="L1912">                    jacobian.setElementAtIndex(8, derivativeXi);</span>
<span class="fc" id="L1913">                    jacobian.setElementAtIndex(9, derivativeYi);</span>
<span class="fc" id="L1914">                    jacobian.setElementAtIndex(10, derivativeZi);</span>
<span class="fc" id="L1915">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L1919">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L1922">        } catch (AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L1923">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (fingerprint rssi variance, path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * rssi variance by considering the 2D 3rd order Taylor expression of received power.
     * Notice that any unknown variance is assumed to be zero.
     * @param fingerprintRssi closest located fingerprint reading RSSI expressed in dBm's.
     * @param pathLossExponent path-loss exponent.
     * @param fingerprintPosition position of closest fingerprint.
     * @param radioSourcePosition radio source position associated to fingerprint reading.
     * @param estimatedPosition  position to be estimated. Usually this is equal to the
     *                           initial position used by a non linear algorithm.
     * @param fingerprintRssiVariance variance of fingerprint RSSI or null if unknown.
     * @param pathLossExponentVariance variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance  covariance of position to be estimated or null
     *                                     if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiVarianceThirdOrderNonLinear2D(
            final double fingerprintRssi, final double pathLossExponent,
            Point2D fingerprintPosition, Point2D radioSourcePosition,
            Point2D estimatedPosition, Double fingerprintRssiVariance,
            Double pathLossExponentVariance,
            Matrix fingerprintPositionCovariance,
            Matrix radioSourcePositionCovariance,
            Matrix estimatedPositionCovariance) throws IndoorException {

<span class="fc bfc" id="L1958" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null ||</span>
                estimatedPosition == null) {
<span class="fc" id="L1960">            return null;</span>
        }

        //3rd order Taylor expression of received power in 2D:
        //Pr(pi) = Pr(p1)
        //  -10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1) +
        //  -10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1) +
        //  -5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2 +
        //  -5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*d1a^4)*(yi - y1)^2 +
        //  20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4)*(xi - x1)*(yi - y1) +
        //  -10/6*n/ln(10)*(-2*(x1 - xa)*dia^4 - ((y1 - ya)^2 - (x1 - xa)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)^3 +
        //  -10/6*n/ln(10)*(-2*(y1 - ya)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2)*4*d1a^2*(y1 - ya))/d1a^8*(yi - y1)^3 +
        //  -5*n/ln(10)*(2*(y1 - ya)*d1a^4 - ((y1 - ya)^2 - (x1 - xa)^2)*4*d1a^2*(y1 - ya))/d1a^8*(xi - x1)^2*(yi - y1) +
        //  -5*n/ln(10)*(2*(x1 - xa)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)*(yi - y1)^2
        //where d1a2 = (x1 - xa)^2 + (y1 - ya)^2

<span class="fc" id="L1976">        final double x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L1977">        final double y1 = fingerprintPosition.getInhomY();</span>

<span class="fc" id="L1979">        final double xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L1980">        final double ya = radioSourcePosition.getInhomY();</span>

<span class="fc" id="L1982">        final double xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L1983">        final double yi = estimatedPosition.getInhomY();</span>

<span class="fc" id="L1985">        double[] mean = new double[] {</span>
                fingerprintRssi, pathLossExponent, x1, y1, xa, ya, xi, yi
        };
<span class="fc" id="L1988">        Matrix covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L1989" title="All 2 branches covered.">                fingerprintRssiVariance != null ? fingerprintRssiVariance : 0.0,</span>
<span class="fc bfc" id="L1990" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L1994" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L1995" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L1996" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L1998">            covariance.setSubmatrix(2, 2,</span>
                    3, 3,
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L2003" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L2004" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L2005" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L2006">            covariance.setSubmatrix(4, 4,</span>
                    5, 5,
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L2011" title="All 2 branches covered.">        if (estimatedPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L2012" title="1 of 2 branches missed.">                estimatedPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L2013" title="1 of 2 branches missed.">                estimatedPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L2014">            covariance.setSubmatrix(6, 6,</span>
                    7, 7,
                    estimatedPositionCovariance);
        }

        try {
            //although less precise, we use a jacobian estimator to simplify expressions
<span class="fc" id="L2021">            final MultiVariateFunctionEvaluatorListener evaluator = new MultiVariateFunctionEvaluatorListener() {</span>
                @Override
                public void evaluate(double[] point, double[] result) {
                    //Pr(pi) = Pr(p1)
                    //  -10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
                    //  -10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
                    //  -5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*d1a^4)*(yi - y1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4)*(xi - x1)*(yi - y1)
                    //  -10/6*n/ln(10)*(-2*(x1 - xa)*dia^4 - ((y1 - ya)^2 - (x1 - xa)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)^3
                    //  -10/6*n/ln(10)*(-2*(y1 - ya)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2)*4*d1a^2*(y1 - ya))/d1a^8*(yi - y1)^3
                    //  -5*n/ln(10)*(2*(y1 - ya)*d1a^4 - ((y1 - ya)^2 - (x1 - xa)^2)*4*d1a^2*(y1 - ya))/d1a^8*(xi - x1)^2*(yi - y1)
                    //  -5*n/ln(10)*(2*(x1 - xa)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)*(yi - y1)^2
                    //where d1a2 = (x1 - xa)^2 + (y1 - ya)^2

                    //Hence:
                    //Pr(pi) = Pr(p1)
                    //  -10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*(xi - x1)
                    //  -10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*(yi - y1)
                    //  -5*n*((y1 - ya)^2 - (x1 - xa)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)*(xi - x1)^2
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)*(yi - y1)^2
                    //  +20*n*(x1 - xa)*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)^2)*(xi - x1)*(yi - y1)
                    //  -10/6*n/ln(10)*(-2*(x1 - xa)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((y1 - ya)^2 - (x1 - xa)^2)*4*((x1 - xa)^2 + (y1 - ya)^2)*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^4*(xi - x1)^3
                    //  -10/6*n/ln(10)*(-2*(y1 - ya)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*4*((x1 - xa)^2 + (y1 - ya)^2)*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^4*(yi - y1)^3
                    //  -5*n/ln(10)*(2*(y1 - ya)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((y1 - ya)^2 - (x1 - xa)^2)*4*((x1 - xa)^2 + (y1 - ya)^2)*(y1 - ya))/((x1 - xa)^2 + (y1 - ya)^2)^4*(xi - x1)^2*(yi - y1)
                    //  -5*n/ln(10)*(2*(x1 - xa)*((x1 - xa)^2 + (y1 - ya)^2)^2 - ((x1 - xa)^2 - (y1 - ya)^2)*4*((x1 - xa)^2 + (y1 - ya)^2)*(x1 - xa))/((x1 - xa)^2 + (y1 - ya)^2)^4*(xi - x1)*(yi - y1)^2

<span class="fc" id="L2048">                    double fingerprintRssi = point[0];</span>
<span class="fc" id="L2049">                    double pathLossExponent = point[1];</span>
<span class="fc" id="L2050">                    double x1 = point[2];</span>
<span class="fc" id="L2051">                    double y1 = point[3];</span>
<span class="fc" id="L2052">                    double xa = point[4];</span>
<span class="fc" id="L2053">                    double ya = point[5];</span>
<span class="fc" id="L2054">                    double xi = point[6];</span>
<span class="fc" id="L2055">                    double yi = point[7];</span>

<span class="fc" id="L2057">                    double diffX1a = x1 - xa;</span>
<span class="fc" id="L2058">                    double diffY1a = y1 - ya;</span>

<span class="fc" id="L2060">                    double diffXi1 = xi - x1;</span>
<span class="fc" id="L2061">                    double diffYi1 = yi - y1;</span>

<span class="fc" id="L2063">                    double diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L2064">                    double diffY1a2 = diffY1a * diffY1a;</span>

<span class="fc" id="L2066">                    double diffXi12 = diffXi1 * diffXi1;</span>
<span class="fc" id="L2067">                    double diffYi12 = diffYi1 * diffYi1;</span>

<span class="fc" id="L2069">                    double diffXi13 = diffXi12 * diffXi1;</span>
<span class="fc" id="L2070">                    double diffYi13 = diffYi12 * diffYi1;</span>

<span class="fc" id="L2072">                    double d1a2 = diffX1a2 + diffY1a2;</span>
<span class="fc" id="L2073">                    double d1a4 = d1a2 * d1a2;</span>
<span class="fc" id="L2074">                    double d1a8 = d1a4 * d1a4;</span>

<span class="fc" id="L2076">                    double ln10 = Math.log(10.0);</span>

<span class="fc" id="L2078">                    result[0] = fingerprintRssi</span>
                            -10.0 * pathLossExponent* diffX1a / (ln10*d1a2) * diffXi1
                            -10.0 * pathLossExponent * diffY1a / (ln10 * d1a2) * diffYi1
                            -5.0 * pathLossExponent *(-diffX1a2 + diffY1a2) / (ln10 * d1a4) * diffXi12
                            -5.0 * pathLossExponent * (diffX1a2 - diffY1a2) / (ln10 * d1a4)* diffYi12
                            + 20.0 * pathLossExponent * diffX1a * diffY1a / (ln10 * d1a4) * diffXi1 * diffYi1
                            - 10.0 / 6.0 * pathLossExponent / ln10 * (-2.0 * diffX1a * d1a4 - (- diffX1a2 + diffY1a2) * 4.0 * d1a2 * diffX1a) / d1a8 * diffXi13
                            - 10.0 / 6.0 * pathLossExponent / ln10 * (-2.0 * diffY1a * d1a4 - (diffX1a2 - diffY1a2) * 4.0 * d1a2 * diffY1a) / d1a8 * diffYi13
                            -5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * d1a4 - (-diffX1a2 + diffY1a2) * 4.0 * d1a2 * diffY1a) / d1a8 * diffXi12 * diffYi1
                            -5.0 * pathLossExponent / ln10 * (2.0 * diffX1a * d1a4 - (diffX1a2 - diffY1a2) * 4.0 * d1a2 * diffX1a) / d1a8 * diffXi1 * diffYi12;
<span class="fc" id="L2088">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L2092">                    return 1;</span>
                }
            };

<span class="fc" id="L2096">            final JacobianEstimator jacobianEstimator = new JacobianEstimator(evaluator);</span>

<span class="fc" id="L2098">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(double[] x, double[] y, Matrix jacobian) {

                    try {
<span class="fc" id="L2103">                        evaluator.evaluate(x, y);</span>
<span class="fc" id="L2104">                        jacobianEstimator.jacobian(x, jacobian);</span>
<span class="nc" id="L2105">                    } catch (EvaluationException ignore) {</span>
                        //never happens
<span class="fc" id="L2107">                    }</span>
<span class="fc" id="L2108">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L2112">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L2115">        } catch (AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L2116">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (fingerprint rssi variance, path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * rssi variance by considering the 3D 3rd order Taylor expression of received power.
     * Notice that any unknown variance is assumed to be zero.
     * @param fingerprintRssi closest located fingerprint reading RSSI expressed in dBm's.
     * @param pathLossExponent path-loss exponent.
     * @param fingerprintPosition position of closest fingerprint.
     * @param radioSourcePosition radio source position associated to fingerprint reading.
     * @param estimatedPosition  position to be estimated. Usually this is equal to the
     *                           initial position used by a non linear algorithm.
     * @param fingerprintRssiVariance variance of fingerprint RSSI or null if unknown.
     * @param pathLossExponentVariance variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance  covariance of position to be estimated or null
     *                                     if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiVarianceThirdOrderNonLinear3D(
            final double fingerprintRssi, final double pathLossExponent,
            Point3D fingerprintPosition, Point3D radioSourcePosition,
            Point3D estimatedPosition,
            Double fingerprintRssiVariance,
            Double pathLossExponentVariance,
            Matrix fingerprintPositionCovariance,
            Matrix radioSourcePositionCovariance,
            Matrix estimatedPositionCovariance) throws IndoorException {

<span class="fc bfc" id="L2152" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null ||</span>
                estimatedPosition == null) {
<span class="fc" id="L2154">            return null;</span>
        }

        //1st order Taylor expression of received power in 3D:
        //Pr(pi) = Pr(p1)
        //  - 10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1)
        //  - 10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1)
        //  - 10*n*(z1 - za)/(ln(10)*d1a^2)*(zi - z1)
        //where d1a^2 = (x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2

<span class="fc" id="L2164">        final double x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L2165">        final double y1 = fingerprintPosition.getInhomY();</span>
<span class="fc" id="L2166">        final double z1 = fingerprintPosition.getInhomZ();</span>

<span class="fc" id="L2168">        final double xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L2169">        final double ya = radioSourcePosition.getInhomY();</span>
<span class="fc" id="L2170">        final double za = radioSourcePosition.getInhomZ();</span>

<span class="fc" id="L2172">        final double xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L2173">        final double yi = estimatedPosition.getInhomY();</span>
<span class="fc" id="L2174">        final double zi = estimatedPosition.getInhomZ();</span>

<span class="fc" id="L2176">        double[] mean = new double[] {</span>
                fingerprintRssi, pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
        };
<span class="fc" id="L2179">        Matrix covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L2180" title="All 2 branches covered.">                fingerprintRssiVariance != null ? fingerprintRssiVariance : 0.0,</span>
<span class="fc bfc" id="L2181" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L2185" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L2186" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L2187" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L2189">            covariance.setSubmatrix(2, 2,</span>
                    4, 4,
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L2194" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L2195" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L2196" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L2197">            covariance.setSubmatrix(5, 5,</span>
                    7, 7,
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L2202" title="All 2 branches covered.">        if (estimatedPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L2203" title="1 of 2 branches missed.">                estimatedPositionCovariance.getRows() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L2204" title="1 of 2 branches missed.">                estimatedPositionCovariance.getColumns() == Point3D.POINT3D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L2205">            covariance.setSubmatrix(8, 8,</span>
                    10, 10,
                    estimatedPositionCovariance);
        }

        try {
            //although less precise, we use a jacobian estimator to simplify expressions
<span class="fc" id="L2212">            final MultiVariateFunctionEvaluatorListener evaluator = new MultiVariateFunctionEvaluatorListener() {</span>
                @Override
                public void evaluate(double[] point, double[] result) {
                    //Pr(pi = (xi,yi)) = Pr(p1) +
                    //  -10*n*(x1 - xa)/(ln(10)*d1a^2)*(xi - x1) +
                    //  -10*n*(y1 - ya)/(ln(10)*d1a^2)*(yi - y1) +
                    //  -10*n*(z1 - za)/(ln(10)*d1a^2)*(zi - z1) +
                    //  -5*n*((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)/(ln(10)*d1a^4)*(xi - x1)^2 +
                    //  -5*n*((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)/(ln(10)*d1a^4)*(yi - y1)^2 +
                    //  -5*n*((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)/(ln(10)*d1a^4)*(zi - z1)^2 +
                    //  20*n*(x1 - xa)*(y1 - ya)/(ln(10)*d1a^4)*(xi - x1)*(yi - y1) +
                    //  20*n*(y1 - ya)*(z1 - za)/(ln(10)*d1a^4)*(yi - y1)*(zi - z1) +
                    //  20*n*(x1 - xa)*(z1 - za)/(ln(10)*d1a^4)*(xi - x1)*(zi - z1) +
                    //  -10/6*n/ln(10)*(-2*(x1 - xa)*d1a^4 - ((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)^3 +
                    //  -10/6*n/ln(10)*(-2*(y1 - ya)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*4*d1a^2*(y1 - ya))/d1a^8*(yi - y1)^3 +
                    //  -10/6*n/ln(10)*(-2*(z1 - za)*d1a^4 - ((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*4*d1a^2*(z1 - za))/d1a^8*(zi - z1)^3 +
                    //  -5*n/ln(10)*(2*(y1 - ya)*d1a^4 - ((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*4*d1a^2*(y1 - ya))/d1a^8*(xi - x1)^2*(yi - y1) +
                    //  -5*n/ln(10)*(2*(z1 - za)*d1a^4 - ((y1 - ya)^2 + (z1 - za)^2 - (x1 - xa)^2)*4*d1a^2*(z1 - za))/d1a^8*(xi - x1)^2*(zi - z1) +
                    //  -5*n/ln(10)*(2*(x1 - xa)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)*(yi - y1)^2 +
                    //  -5*n/ln(10)*(2*(x1 - xa)*d1a^4 - ((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*4*d1a^2*(x1 - xa))/d1a^8*(xi - x1)*(zi - z1)^2 +
                    //  -5*n/ln(10)*(2*(z1 - za)*d1a^4 - ((x1 - xa)^2 - (y1 - ya)^2 + (z1 - za)^2)*4*d1a^2*(z1 - za))/d1a^8*(yi - y1)^2*(zi - z1) +
                    //  -5*n/ln(10)*(2*(y1 - ya)*d1a^4 - ((x1 - xa)^2 + (y1 - ya)^2 - (z1 - za)^2)*4*d1a^2*(y1 - ya))/d1a^8*(yi - y1)*(zi - z1)^2 +
                    //  -80*n/ln(10)*((x1 - xa)*(y1 - ya)*(z1 - za)*d1a^2)/d1a^8*(xi - x1)*(yi - y1)*(zi - z1)

<span class="fc" id="L2236">                    double fingerprintRssi = point[0];</span>
<span class="fc" id="L2237">                    double pathLossExponent = point[1];</span>
<span class="fc" id="L2238">                    double x1 = point[2];</span>
<span class="fc" id="L2239">                    double y1 = point[3];</span>
<span class="fc" id="L2240">                    double z1 = point[4];</span>
<span class="fc" id="L2241">                    double xa = point[5];</span>
<span class="fc" id="L2242">                    double ya = point[6];</span>
<span class="fc" id="L2243">                    double za = point[7];</span>
<span class="fc" id="L2244">                    double xi = point[8];</span>
<span class="fc" id="L2245">                    double yi = point[9];</span>
<span class="fc" id="L2246">                    double zi = point[10];</span>

<span class="fc" id="L2248">                    double diffX1a = x1 - xa;</span>
<span class="fc" id="L2249">                    double diffY1a = y1 - ya;</span>
<span class="fc" id="L2250">                    double diffZ1a = z1 - za;</span>

<span class="fc" id="L2252">                    double diffXi1 = xi - x1;</span>
<span class="fc" id="L2253">                    double diffYi1 = yi - y1;</span>
<span class="fc" id="L2254">                    double diffZi1 = zi - z1;</span>

<span class="fc" id="L2256">                    double diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L2257">                    double diffY1a2 = diffY1a * diffY1a;</span>
<span class="fc" id="L2258">                    double diffZ1a2 = diffZ1a * diffZ1a;</span>

<span class="fc" id="L2260">                    double diffXi12 = diffXi1 * diffXi1;</span>
<span class="fc" id="L2261">                    double diffYi12 = diffYi1 * diffYi1;</span>
<span class="fc" id="L2262">                    double diffZi12 = diffZi1 * diffZi1;</span>

<span class="fc" id="L2264">                    double diffXi13 = diffXi12 * diffXi1;</span>
<span class="fc" id="L2265">                    double diffYi13 = diffYi12 * diffYi1;</span>
<span class="fc" id="L2266">                    double diffZi13 = diffZi12 * diffZi1;</span>

<span class="fc" id="L2268">                    double d1a2 = diffX1a2 + diffY1a2 + diffZ1a2;</span>
<span class="fc" id="L2269">                    double d1a4 = d1a2 * d1a2;</span>
<span class="fc" id="L2270">                    double d1a8 = d1a4 * d1a4;</span>

<span class="fc" id="L2272">                    double ln10 = Math.log(10.0);</span>

<span class="fc" id="L2274">                    double value1 = - 10.0 * pathLossExponent * diffX1a / (ln10 * d1a2);</span>
<span class="fc" id="L2275">                    double value2 = - 10.0 * pathLossExponent * diffY1a / (ln10 * d1a2);</span>
<span class="fc" id="L2276">                    double value3 = - 10.0 * pathLossExponent * diffZ1a / (ln10 * d1a2);</span>
<span class="fc" id="L2277">                    double value4 = - 5.0 * pathLossExponent * (-diffX1a2 + diffY1a2 + diffZ1a2) / (ln10 * d1a4);</span>
<span class="fc" id="L2278">                    double value5 = - 5.0 * pathLossExponent * (diffX1a2 - diffY1a2 + diffZ1a2) / (ln10 * d1a4);</span>
<span class="fc" id="L2279">                    double value6 = - 5.0 * pathLossExponent * (diffX1a2 + diffY1a2 - diffZ1a2) / (ln10 * d1a4);</span>
<span class="fc" id="L2280">                    double value7 = 20.0 * pathLossExponent * diffX1a * diffY1a / (ln10 * d1a4);</span>
<span class="fc" id="L2281">                    double value8 = 20.0 * pathLossExponent * diffY1a * diffZ1a / (ln10 * d1a4);</span>
<span class="fc" id="L2282">                    double value9 = 20.0 * pathLossExponent * diffX1a * diffZ1a / (ln10 * d1a4);</span>
<span class="fc" id="L2283">                    double value10 = - 10.0 / 6.0 * pathLossExponent / ln10 * (-2.0 * diffX1a * d1a4 - (-diffX1a2 + diffY1a2 + diffZ1a2) * 4.0 * d1a2 * diffX1a) / d1a8;</span>
<span class="fc" id="L2284">                    double value11 = - 10.0 / 6.0 * pathLossExponent / ln10 * (-2.0 * diffY1a * d1a4 - (diffX1a2 - diffY1a2 + diffZ1a2) * 4.0 * d1a2 * diffY1a) / d1a8;</span>
<span class="fc" id="L2285">                    double value12 = - 10.0 / 6.0 * pathLossExponent / ln10 * (-2.0 * diffZ1a * d1a4 - (diffX1a2 + diffY1a2 - diffZ1a2) * 4.0 * d1a2 * diffZ1a) / d1a8;</span>
<span class="fc" id="L2286">                    double value13 = - 5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * d1a4 - (-diffX1a2 + diffY1a2 + diffZ1a2) * 4.0 * d1a2 * diffY1a) / d1a8;</span>
<span class="fc" id="L2287">                    double value14 = - 5.0 * pathLossExponent / ln10 * (2.0 * diffZ1a * d1a4 - (-diffX1a2 + diffY1a2 + diffZ1a2) * 4.0 * d1a2 * diffZ1a) / d1a8;</span>
<span class="fc" id="L2288">                    double value15 = - 5.0 * pathLossExponent / ln10 * (2.0 * diffX1a * d1a4 - (diffX1a2 - diffY1a2 + diffZ1a2) * 4.0 * d1a2 * diffX1a) / d1a8;</span>
<span class="fc" id="L2289">                    double value16 = - 5.0 * pathLossExponent / ln10 * (2.0 * diffX1a * d1a4 - (diffX1a2 + diffY1a2 - diffZ1a2) * 4.0 * d1a2 * diffX1a) / d1a8;</span>
<span class="fc" id="L2290">                    double value17 = - 5.0 * pathLossExponent / ln10 * (2.0 * diffZ1a * d1a4 - (diffX1a2 - diffY1a2 + diffZ1a2) * 4.0 * d1a2 * diffZ1a) / d1a8;</span>
<span class="fc" id="L2291">                    double value18 = - 5.0 * pathLossExponent / ln10 * (2.0 * diffY1a * d1a4 - (diffX1a2 + diffY1a2 - diffZ1a2) * 4.0 * d1a2 * diffY1a) / d1a8;</span>
<span class="fc" id="L2292">                    double value19 = - 80.0 * pathLossExponent / ln10 * (diffX1a * diffY1a * diffZ1a * d1a2) / d1a8;</span>

<span class="fc" id="L2294">                    result[0] = fingerprintRssi</span>
                            + value1 * diffXi1
                            + value2 * diffYi1
                            + value3 * diffZi1
                            + value4 * diffXi12
                            + value5 * diffYi12
                            + value6 * diffZi12
                            + value7 * diffXi1 * diffYi1
                            + value8 * diffYi1 * diffZi1
                            + value9 * diffXi1 * diffZi1
                            + value10 * diffXi13
                            + value11 * diffYi13
                            + value12 * diffZi13
                            + value13 * diffXi12 * diffYi1
                            + value14 * diffXi12 * diffZi1
                            + value15 * diffXi1 * diffYi12
                            + value16 * diffXi1 * diffZi12
                            + value17 * diffYi12 * diffZi1
                            + value18 * diffYi1 * diffZi12
                            + value19 * diffXi1 * diffYi1 * diffZi1;
<span class="fc" id="L2314">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L2318">                    return 1;</span>
                }
            };

<span class="fc" id="L2322">            final JacobianEstimator jacobianEstimator = new JacobianEstimator(evaluator);</span>

<span class="fc" id="L2324">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(double[] x, double[] y, Matrix jacobian) {

                    try {
<span class="fc" id="L2329">                        evaluator.evaluate(x, y);</span>
<span class="fc" id="L2330">                        jacobianEstimator.jacobian(x, jacobian);</span>
<span class="nc" id="L2331">                    } catch (EvaluationException ignore) {</span>
                        //never happens
<span class="fc" id="L2333">                    }</span>
<span class="fc" id="L2334">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L2338">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L2341">        } catch (AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L2342">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * difference of rssi variance by considering the 2D expression.
     * Notice that any unknown variance is assumed to be zero.
     * @param pathLossExponent path-loss exponent.
     * @param fingerprintPosition position of closest fingerprint.
     * @param radioSourcePosition radio source position associated to fingerprint reading.
     * @param estimatedPosition  position to be estimated. Usually this is equal to the
     *                           initial position used by a non linear algorithm.
     * @param pathLossExponentVariance variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance  covariance of position to be estimated or null
     *                                     if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiDifferenceVariance2D(
            final double pathLossExponent,
            Point2D fingerprintPosition, Point2D radioSourcePosition,
            Point2D estimatedPosition,
            Double pathLossExponentVariance,
            Matrix fingerprintPositionCovariance,
            Matrix radioSourcePositionCovariance,
            Matrix estimatedPositionCovariance) throws IndoorException {

<span class="fc bfc" id="L2375" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null ||</span>
                estimatedPosition == null) {
<span class="fc" id="L2377">            return null;</span>
        }

        //Expression being used is:
        //Prdiff1a = Pr(pi) - Pr(p1) = 5*n*log(d1a^2) - 5*n*log(dia^2) =
        //  = 5*n*log((x1 - xa)^2 + (y1 - ya)^2) - 5*n*log((xi - xa)^2 + (yi - ya)^2)


<span class="fc" id="L2385">        final double x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L2386">        final double y1 = fingerprintPosition.getInhomY();</span>

<span class="fc" id="L2388">        final double xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L2389">        final double ya = radioSourcePosition.getInhomY();</span>

<span class="fc" id="L2391">        final double xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L2392">        final double yi = estimatedPosition.getInhomY();</span>

<span class="fc" id="L2394">        double[] mean = new double[] {</span>
                pathLossExponent, x1, y1, xa, ya, xi, yi
        };
<span class="fc" id="L2397">        Matrix covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L2398" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L2402" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L2403" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L2404" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="fc" id="L2406">            covariance.setSubmatrix(1, 1,</span>
                    2, 2,
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L2411" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L2412" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L2413" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L2414">            covariance.setSubmatrix(3, 3,</span>
                    4, 4,
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L2419" title="All 2 branches covered.">        if (estimatedPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L2420" title="1 of 2 branches missed.">                estimatedPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="pc bpc" id="L2421" title="1 of 2 branches missed.">                estimatedPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="fc" id="L2422">            covariance.setSubmatrix(5, 5,</span>
                    6, 6,
                    estimatedPositionCovariance);
        }

        try {
<span class="fc" id="L2428">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(double[] x, double[] y, Matrix jacobian) {

                    //Expression being used is:
                    //Prdiff1a = Pr(pi) - Pr(p1) = 5*n*log(d1a^2) - 5*n*log(dia^2) =
                    //  = 5*n*log((x1 - xa)^2 + (y1 - ya)^2) - 5*n*log((xi - xa)^2 + (yi - ya)^2)

<span class="fc" id="L2436">                    double diffX1a = x1 - xa;</span>
<span class="fc" id="L2437">                    double diffY1a = y1 - ya;</span>

<span class="fc" id="L2439">                    double diffXia = xi - xa;</span>
<span class="fc" id="L2440">                    double diffYia = yi - ya;</span>

<span class="fc" id="L2442">                    double diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L2443">                    double diffY1a2 = diffY1a * diffY1a;</span>

<span class="fc" id="L2445">                    double diffXia2 = diffXia * diffXia;</span>
<span class="fc" id="L2446">                    double diffYia2 = diffYia * diffYia;</span>

<span class="fc" id="L2448">                    double d1a2 = diffX1a2 + diffY1a2;</span>
<span class="fc" id="L2449">                    double dia2 = diffXia2 + diffYia2;</span>

<span class="fc" id="L2451">                    double ln10 = Math.log(10.0);</span>


                    //compute gradient (is a jacobian having 1 row and 7 columns)


                    //derivative of diff rssi respect to fingerprint path-loss exponent &quot;n&quot;

<span class="fc" id="L2459">                    double derivativePathLossExponent = 5.0 *</span>
<span class="fc" id="L2460">                            (Math.log10(d1a2) - Math.log10(dia2));</span>


                    //derivative of diff rssi respect to x1
                    //diff(Prdiff1a)/diff(x1) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*2*(x1 - xa) =
                    //  = 10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))

<span class="fc" id="L2467">                    double tmp1a = 10.0 * pathLossExponent / (ln10 * d1a2);</span>
<span class="fc" id="L2468">                    double derivativeX1 = tmp1a * diffX1a;</span>


                    //derivative of diff rssi respect to y1
                    //diff(Prdiff1a)/diff(y1) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*2*(y1 - ya) =
                    //  = 10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))

<span class="fc" id="L2475">                    double derivativeY1 = tmp1a * diffY1a;</span>


                    //derivative of rssi respect to xi
                    //diff(Prdiff1a)/diff(xi) = -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2))*2*(xi - xa)
                    //  = -10*n*(xi - xa)/(ln(10)*((xi - xa)^2 + (yi - ya)^2))

<span class="fc" id="L2482">                    double tmpia = 10.0 * pathLossExponent / (ln10 * dia2);</span>
<span class="fc" id="L2483">                    double derivativeXi = - tmpia * diffXia;</span>

                    //derivative of rssi respect to yi
                    //diff(Prdiff1a)/diff(yi) = -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2))*2*(yi - ya)
                    //  = -10*n*(yi - ya)/(ln(10)*((xi - xa)^2 + (yi - ya)^2))

<span class="fc" id="L2489">                    double derivativeYi = - tmpia * diffYia;</span>


                    //derivative of rssi respect to xa
                    //diff(Prdiff1a)/diff(xa) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*-2*(x1 - xa) -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2))*-2(xi - xa) =
                    //  = -10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)) + 10*n*(xi - xa)/(ln(10)*((xi - xa)^2 + (yi - ya)^2))

<span class="fc" id="L2496">                    double derivativeXa = - derivativeX1 - derivativeXi ;</span>


                    //derivative of rssi respect to ya
                    //diff(Prdiff1a)/diff(ya) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2))*-2*(y1 - ya) -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2))*-2(yi - ya) =
                    //  = -10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2)) + 10*n*(yi - ya)/(ln(10)*((xi - xa)^2 + (yi - ya)^2))

<span class="fc" id="L2503">                    double derivativeYa = - derivativeY1 - derivativeYi ;</span>


                    //Prdiff1a = Pr(pi) - Pr(p1) = 5*n*log(d1a^2) - 5*n*log(dia^2) =
                    //  = 5*n*log((x1 - xa)^2 + (y1 - ya)^2) - 5*n*log((xi - xa)^2 + (yi - ya)^2)


                    //set derivatives pathLossExponent, x1, y1, xa, ya, xi, yi
<span class="fc" id="L2511">                    jacobian.setElementAtIndex(0, derivativePathLossExponent);</span>
<span class="fc" id="L2512">                    jacobian.setElementAtIndex(1, derivativeX1);</span>
<span class="fc" id="L2513">                    jacobian.setElementAtIndex(2, derivativeY1);</span>
<span class="fc" id="L2514">                    jacobian.setElementAtIndex(3, derivativeXa);</span>
<span class="fc" id="L2515">                    jacobian.setElementAtIndex(4, derivativeYa);</span>
<span class="fc" id="L2516">                    jacobian.setElementAtIndex(5, derivativeXi);</span>
<span class="fc" id="L2517">                    jacobian.setElementAtIndex(6, derivativeYi);</span>


<span class="fc" id="L2520">                    y[0] = derivativePathLossExponent * pathLossExponent;</span>
<span class="fc" id="L2521">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L2525">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L2528">        } catch (AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L2529">            throw new IndoorException(e);</span>
        }
    }

    /**
     * Propagates provided variances (path-loss exponent variance,
     * fingerprint position covariance and radio source position covariance) into
     * difference of rssi variance by considering the 3D expression.
     * Notice that any unknown variance is assumed to be zero.
     * @param pathLossExponent path-loss exponent.
     * @param fingerprintPosition position of closest fingerprint.
     * @param radioSourcePosition radio source position associated to fingerprint reading.
     * @param estimatedPosition  position to be estimated. Usually this is equal to the
     *                           initial position used by a non linear algorithm.
     * @param pathLossExponentVariance variance of path-loss exponent or null if unknown.
     * @param fingerprintPositionCovariance covariance of fingerprint position or null if
     *                                      unknown.
     * @param radioSourcePositionCovariance covariance of radio source position or null
     *                                      if unknown.
     * @param estimatedPositionCovariance  covariance of position to be estimated or null
     *                                     if unknown. (This is usually unknown).
     * @return a normal distribution containing expected received RSSI value and its variance.
     * @throws IndoorException if something fails.
     */
    public static MultivariateNormalDist propagateVariancesToRssiDifferenceVariance3D(
            final double pathLossExponent,
            Point3D fingerprintPosition, Point3D radioSourcePosition,
            Point3D estimatedPosition,
            Double pathLossExponentVariance,
            Matrix fingerprintPositionCovariance,
            Matrix radioSourcePositionCovariance,
            Matrix estimatedPositionCovariance) throws IndoorException {

<span class="fc bfc" id="L2562" title="All 6 branches covered.">        if (fingerprintPosition == null || radioSourcePosition == null ||</span>
                estimatedPosition == null) {
<span class="fc" id="L2564">            return null;</span>
        }

        //Expression being used is:
        //Prdiff1a = Pr(pi) - Pr(p1) = 5*n*log(d1a^2) - 5*n*log(dia^2) =
        //  = 5*n*log((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - 5*n*log((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2)


<span class="fc" id="L2572">        final double x1 = fingerprintPosition.getInhomX();</span>
<span class="fc" id="L2573">        final double y1 = fingerprintPosition.getInhomY();</span>
<span class="fc" id="L2574">        final double z1 = fingerprintPosition.getInhomZ();</span>

<span class="fc" id="L2576">        final double xa = radioSourcePosition.getInhomX();</span>
<span class="fc" id="L2577">        final double ya = radioSourcePosition.getInhomY();</span>
<span class="fc" id="L2578">        final double za = radioSourcePosition.getInhomZ();</span>

<span class="fc" id="L2580">        final double xi = estimatedPosition.getInhomX();</span>
<span class="fc" id="L2581">        final double yi = estimatedPosition.getInhomY();</span>
<span class="fc" id="L2582">        final double zi = estimatedPosition.getInhomZ();</span>

<span class="fc" id="L2584">        double[] mean = new double[] {</span>
                pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
        };
<span class="fc" id="L2587">        Matrix covariance = Matrix.diagonal(new double[]{</span>
<span class="fc bfc" id="L2588" title="All 2 branches covered.">                pathLossExponentVariance != null ? pathLossExponentVariance : 0.0,</span>
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0
        });

<span class="fc bfc" id="L2592" title="All 2 branches covered.">        if (fingerprintPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L2593" title="1 of 2 branches missed.">                fingerprintPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="nc bnc" id="L2594" title="All 2 branches missed.">                fingerprintPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>

<span class="nc" id="L2596">            covariance.setSubmatrix(1, 1,</span>
                    3, 3,
                    fingerprintPositionCovariance);
        }

<span class="fc bfc" id="L2601" title="All 2 branches covered.">        if (radioSourcePositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L2602" title="1 of 2 branches missed.">                radioSourcePositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="nc bnc" id="L2603" title="All 2 branches missed.">                radioSourcePositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="nc" id="L2604">            covariance.setSubmatrix(4, 4,</span>
                    6, 6,
                    radioSourcePositionCovariance);
        }

<span class="fc bfc" id="L2609" title="All 2 branches covered.">        if (estimatedPositionCovariance != null &amp;&amp;</span>
<span class="pc bpc" id="L2610" title="1 of 2 branches missed.">                estimatedPositionCovariance.getRows() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH &amp;&amp;</span>
<span class="nc bnc" id="L2611" title="All 2 branches missed.">                estimatedPositionCovariance.getColumns() == Point2D.POINT2D_INHOMOGENEOUS_COORDINATES_LENGTH) {</span>
<span class="nc" id="L2612">            covariance.setSubmatrix(7, 7,</span>
                    9, 9,
                    estimatedPositionCovariance);
        }

        try {
<span class="fc" id="L2618">            return MultivariateNormalDist.propagate(new MultivariateNormalDist.JacobianEvaluator() {</span>
                @Override
                public void evaluate(double[] x, double[] y, Matrix jacobian) {

                    //Expression being used is:
                    //Prdiff1a = Pr(pi) - Pr(p1) = 5*n*log(d1a^2) - 5*n*log(dia^2) =
                    //  = 5*n*log((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - 5*n*log((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2)

<span class="fc" id="L2626">                    double diffX1a = x1 - xa;</span>
<span class="fc" id="L2627">                    double diffY1a = y1 - ya;</span>
<span class="fc" id="L2628">                    double diffZ1a = z1 - za;</span>

<span class="fc" id="L2630">                    double diffXia = xi - xa;</span>
<span class="fc" id="L2631">                    double diffYia = yi - ya;</span>
<span class="fc" id="L2632">                    double diffZia = zi - za;</span>

<span class="fc" id="L2634">                    double diffX1a2 = diffX1a * diffX1a;</span>
<span class="fc" id="L2635">                    double diffY1a2 = diffY1a * diffY1a;</span>
<span class="fc" id="L2636">                    double diffZ1a2 = diffZ1a * diffZ1a;</span>

<span class="fc" id="L2638">                    double diffXia2 = diffXia * diffXia;</span>
<span class="fc" id="L2639">                    double diffYia2 = diffYia * diffYia;</span>
<span class="fc" id="L2640">                    double diffZia2 = diffZia * diffZia;</span>

<span class="fc" id="L2642">                    double d1a2 = diffX1a2 + diffY1a2 + diffZ1a2;</span>
<span class="fc" id="L2643">                    double dia2 = diffXia2 + diffYia2 + diffZia2;</span>

<span class="fc" id="L2645">                    double ln10 = Math.log(10.0);</span>


                    //compute gradient (is a jacobian having 1 row and 10 columns)

                    //derivative of diff rssi respect to fingerprint path-loss exponent &quot;n&quot;

<span class="fc" id="L2652">                    double derivativePathLossExponent = 5.0 *</span>
<span class="fc" id="L2653">                            (Math.log10(d1a2) - Math.log10(dia2));</span>


                    //derivative of diff rssi respect to x1
                    //diff(Prdiff1a)/diff(x1) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*2*(x1 - xa) =
                    //  = 10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

<span class="fc" id="L2660">                    double tmp1a = 10.0 * pathLossExponent / (ln10 * d1a2);</span>
<span class="fc" id="L2661">                    double derivativeX1 = tmp1a * diffX1a;</span>


                    //derivative of diff rssi respect to y1
                    //diff(Prdiff1a)/diff(y1) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2) + (z1 - za)^2)*2*(y1 - ya) =
                    //  = 10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

<span class="fc" id="L2668">                    double derivativeY1 = tmp1a * diffY1a;</span>


                    //derivative of diff rssi respect to z1
                    //diff(Prdiff1a)/diff(z1) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2) + (z1 - za)^2)*2*(z1 - za) =
                    //  = 10*n*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))

<span class="fc" id="L2675">                    double derivativeZ1 = tmp1a * diffZ1a;</span>


                    //derivative of rssi respect to xi
                    //diff(Prdiff1a)/diff(xi) = -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))*2*(xi - xa)
                    //  = -10*n*(xi - xa)/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))

<span class="fc" id="L2682">                    double tmpia = 10.0 * pathLossExponent / (ln10 * dia2);</span>
<span class="fc" id="L2683">                    double derivativeXi = - tmpia * diffXia;</span>


                    //derivative of rssi respect to yi
                    //diff(Prdiff1a)/diff(yi) = -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))*2*(yi - ya)
                    //  = -10*n*(yi - ya)/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))

<span class="fc" id="L2690">                    double derivativeYi = - tmpia * diffYia;</span>


                    //derivative of rssi respect to zi
                    //diff(Prdiff1a)/diff(zi) = -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))*2*(zi - za)
                    //  = -10*n*(zi - za)/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))

<span class="fc" id="L2697">                    double derivativeZi = - tmpia * diffZia;</span>


                    //Prdiff1a = Pr(pi) - Pr(p1) = 5*n*log(d1a^2) - 5*n*log(dia^2) =
                    //  = 5*n*log((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2) - 5*n*log((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2)

                    //derivative of rssi respect to xa
                    //diff(Prdiff1a)/diff(xa) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*-2*(x1 - xa) -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))*-2(xi - xa) =
                    //  = -10*n*(x1 - xa)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)) + 10*n*(xi - xa)/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))

<span class="fc" id="L2707">                    double derivativeXa = - derivativeX1 - derivativeXi;</span>


                    //derivative of rssi respect to ya
                    //diff(Prdiff1a)/diff(ya) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*-2*(y1 - ya) -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))*-2(yi - ya) =
                    //  = -10*n*(y1 - ya)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)) + 10*n*(yi - ya)/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))

<span class="fc" id="L2714">                    double derivativeYa = - derivativeY1 - derivativeYi;</span>


                    //derivative of rssi respect to za
                    //diff(Prdiff1a)/diff(za) = 5*n/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2))*-2*(z1 - za) -5*n/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))*-2(zi - za) =
                    //  = -10*n*(z1 - za)/(ln(10)*((x1 - xa)^2 + (y1 - ya)^2 + (z1 - za)^2)) + 10*n*(zi - za)/(ln(10)*((xi - xa)^2 + (yi - ya)^2 + (zi - za)^2))

<span class="fc" id="L2721">                    double derivativeZa = - derivativeZ1 - derivativeZi;</span>


                    //set derivatives pathLossExponent, x1, y1, z1, xa, ya, za, xi, yi, zi
<span class="fc" id="L2725">                    jacobian.setElementAtIndex(0, derivativePathLossExponent);</span>
<span class="fc" id="L2726">                    jacobian.setElementAtIndex(1, derivativeX1);</span>
<span class="fc" id="L2727">                    jacobian.setElementAtIndex(2, derivativeY1);</span>
<span class="fc" id="L2728">                    jacobian.setElementAtIndex(3, derivativeZ1);</span>
<span class="fc" id="L2729">                    jacobian.setElementAtIndex(4, derivativeXa);</span>
<span class="fc" id="L2730">                    jacobian.setElementAtIndex(5, derivativeYa);</span>
<span class="fc" id="L2731">                    jacobian.setElementAtIndex(6, derivativeZa);</span>
<span class="fc" id="L2732">                    jacobian.setElementAtIndex(7, derivativeXi);</span>
<span class="fc" id="L2733">                    jacobian.setElementAtIndex(8, derivativeYi);</span>
<span class="fc" id="L2734">                    jacobian.setElementAtIndex(9, derivativeZi);</span>


<span class="fc" id="L2737">                    y[0] = derivativePathLossExponent * pathLossExponent;</span>
<span class="fc" id="L2738">                }</span>

                @Override
                public int getNumberOfVariables() {
<span class="fc" id="L2742">                    return 1;</span>
                }
            }, mean, covariance);
<span class="nc" id="L2745">        } catch (AlgebraException | StatisticsException e) {</span>
<span class="nc" id="L2746">            throw new IndoorException(e);</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>